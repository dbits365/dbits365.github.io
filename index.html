<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Dbits">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Dbits">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Dbits">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>Dbits</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Dbits</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/21/MongoDB-Compression/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dbits">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dbits">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/21/MongoDB-Compression/" itemprop="url">MongoDB-Compression</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-21T09:15:51+08:00">
                2019-06-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MongoDB/" itemprop="url" rel="index">
                    <span itemprop="name">MongoDB</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/06/21/MongoDB-Compression/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/06/21/MongoDB-Compression/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="压缩-compression"><a href="#压缩-compression" class="headerlink" title="压缩 compression"></a>压缩 compression</h1><h2 id="3-0的压缩"><a href="#3-0的压缩" class="headerlink" title="3.0的压缩"></a>3.0的压缩</h2><ol>
<li>随机数据压缩率不高</li>
<li>二进制格式压缩率不高</li>
<li>文本格式压缩效率高</li>
<li>filed name压缩率高（或者通过降低filed name长度也可以优化）</li>
</ol>
<h2 id="prefix-index-compress"><a href="#prefix-index-compress" class="headerlink" title="prefix index compress"></a>prefix index compress</h2><ol>
<li>如果索引是low cardinality ，比如国家、性别，如果在组合索引（compound indexe）的第一个字段是大量重复值（低选择性），MongoDB 3.0开始默认支持索引前缀压缩（Snappy 或者 zlib）</li>
<li>集合的数据在磁盘上是压缩格式，读取到RAM中会解压缩。但是索引的prefix compression在RAM中还是压缩的格式，这样可以在RAM里缓存更多的索引。</li>
</ol>
<h2 id="启用压缩"><a href="#启用压缩" class="headerlink" title="启用压缩"></a>启用压缩</h2><ul>
<li>MongoDB 3.0的 WireTiger默认开启了集合和索引的压缩</li>
<li>显式开启复制集压缩，使用–wiredTigerCollectionBlockCompressor</li>
<li>指定特定集合开启压缩<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.createCollection( &quot;email&quot;, &#123; storageEngine: &#123;</span><br><span class="line">                       wiredTiger: &#123; configString: &quot;blockCompressor=zlib&quot; &#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="验证压缩效果"><a href="#验证压缩效果" class="headerlink" title="验证压缩效果"></a>验证压缩效果</h2><p>最简单的办法是开启和关闭压缩，分别加载数据，然后查看占用的大小<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.stats(1024*1024).dataSize + db.stats(1024*1024).indexSize</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/02/MongoDB-2dsphere-2d-index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dbits">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dbits">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/02/MongoDB-2dsphere-2d-index/" itemprop="url">MongoDB - 2dsphere&2d index</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-02T10:31:56+08:00">
                2019-04-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MongoDB/" itemprop="url" rel="index">
                    <span itemprop="name">MongoDB</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/04/02/MongoDB-2dsphere-2d-index/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/04/02/MongoDB-2dsphere-2d-index/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="2dsphere"><a href="#2dsphere" class="headerlink" title="2dsphere"></a>2dsphere</h2><ol>
<li>支持地理位置上包含、交叉、附近类型的查询</li>
<li>支持存储的数据为GeoJSON或者传统的经纬度（转化为GeoJSON的一个点）</li>
<li>支持sparse属性（文档没有对应的field，不会更新索引）</li>
<li>包含2dsphere field的索引，只有这个field会决定是否使用该索引</li>
<li>如果集合里包含多个2dsphere、2d索引，在$geoNear中指定key；如果不指定，默认先使用第一个2d索引，没有再使用第一个2dsphere索引</li>
<li>2dsphere的filed不能是片键</li>
<li>2dsphere可以参照多个location和非location字段；2d索引只能参照1个location和1个非location字段</li>
</ol>
<h2 id="创建2dsphere索引"><a href="#创建2dsphere索引" class="headerlink" title="创建2dsphere索引"></a>创建2dsphere索引</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.createIndex( &#123; &lt;location field&gt; : &quot;2dsphere&quot; &#125; )</span><br></pre></td></tr></table></figure>
<h2 id="带位置信息的复合索引，不需要loc字段前缀"><a href="#带位置信息的复合索引，不需要loc字段前缀" class="headerlink" title="带位置信息的复合索引，不需要loc字段前缀"></a>带位置信息的复合索引，不需要loc字段前缀</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.places.createIndex( &#123; loc : &quot;2dsphere&quot; , category : -1, name: 1 &#125; )</span><br></pre></td></tr></table></figure>
<blockquote>
<p>2dsphere复合索引不需要loc字段作为前缀，2d复合索引需要loc字段作为前缀</p>
</blockquote>
<h2 id="2dspehere的查询"><a href="#2dspehere的查询" class="headerlink" title="2dspehere的查询"></a>2dspehere的查询</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">## 多边形内的查询</span><br><span class="line">db.&lt;collection&gt;.find( &#123; &lt;location field&gt; :</span><br><span class="line">                         &#123; $geoWithin :</span><br><span class="line">                           &#123; $geometry :</span><br><span class="line">                             &#123; type : &quot;Polygon&quot; ,</span><br><span class="line">                               coordinates : [ &lt;coordinates&gt; ]</span><br><span class="line">                      &#125; &#125; &#125; &#125; )</span><br><span class="line"></span><br><span class="line">## 多边形交叉</span><br><span class="line">db.&lt;collection&gt;.find( &#123; &lt;location field&gt; :</span><br><span class="line">                         &#123; $geoIntersects :</span><br><span class="line">                           &#123; $geometry :</span><br><span class="line">                             &#123; type : &quot;&lt;GeoJSON object type&gt;&quot; ,</span><br><span class="line">                               coordinates : [ &lt;coordinates&gt; ]</span><br><span class="line">                      &#125; &#125; &#125; &#125; )</span><br><span class="line"></span><br><span class="line">## 临近查询</span><br><span class="line">db.&lt;collection&gt;.find( &#123; &lt;location field&gt; :</span><br><span class="line">                         &#123; $near :</span><br><span class="line">                           &#123; $geometry :</span><br><span class="line">                              &#123; type : &quot;Point&quot; ,</span><br><span class="line">                                coordinates : [ &lt;longitude&gt; , &lt;latitude&gt; ] &#125; ,</span><br><span class="line">                             $maxDistance : &lt;distance in meters&gt;</span><br><span class="line">                      &#125; &#125; &#125; )</span><br><span class="line"></span><br><span class="line">## 圆内的查询</span><br><span class="line">db.&lt;collection&gt;.find( &#123; &lt;location field&gt; :</span><br><span class="line">                         &#123; $geoWithin :</span><br><span class="line">                           &#123; $centerSphere :</span><br><span class="line">                              [ [ &lt;x&gt;, &lt;y&gt; ] , &lt;radius&gt; ] &#125;</span><br><span class="line">                      &#125; &#125; )</span><br></pre></td></tr></table></figure>
<h2 id="2d索引"><a href="#2d索引" class="headerlink" title="2d索引"></a>2d索引</h2><h2 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a>创建索引</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">db.&lt;collection&gt;.createIndex( &#123; &lt;location field&gt; : &quot;2d&quot; ,</span><br><span class="line">                               &lt;additional field&gt; : &lt;value&gt; &#125; ,</span><br><span class="line">                             &#123; &lt;index-specification options&gt; &#125; )</span><br><span class="line"></span><br><span class="line">## 查询</span><br><span class="line">db.&lt;collection&gt;.find( &#123; &lt;location field&gt; :</span><br><span class="line">                         &#123; $geoWithin :</span><br><span class="line">                            &#123; $box|$polygon|$center : &lt;coordinates&gt;</span><br><span class="line">                      &#125; &#125; &#125; )</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/09/MongoDB分片数据库无法drop集合/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dbits">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dbits">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/09/MongoDB分片数据库无法drop集合/" itemprop="url">MongoDB分片数据库无法drop集合</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-09T13:00:46+08:00">
                2018-05-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Troubleshooting/" itemprop="url" rel="index">
                    <span itemprop="name">Troubleshooting</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/05/09/MongoDB分片数据库无法drop集合/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/05/09/MongoDB分片数据库无法drop集合/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="故障现象"><a href="#故障现象" class="headerlink" title="故障现象"></a>故障现象</h2><p>开发在drop一个集合的时候报timeout超时错误。错误信息：Timed out waiting for <strong>db.collection</strong></p>
<p>此环境为3分片复制集，复制集PSA架构（Primary + Secondary + Arbitor），shard1和shard3上的secondary状态为down。</p>
<h2 id="故障分析"><a href="#故障分析" class="headerlink" title="故障分析"></a>故障分析</h2><p>分析日志，有大量如下报错信息：<br>    [migrateThread] Waiting for replication to catch up before entering critical section</p>
<pre><code>[migrateThread] migrate commit waiting for a majority of slaves for &apos;**db.collection**&apos; { SecurityID: MinKey } -&gt; { SecurityID: -9115002770324251294 } waiting for: { ts: Timestamp 1522170033000|3552, t: 4 }
</code></pre><p>日志显示的chunk migration过程中（shard1向shard3迁移），由于复制集内的1个从节点down掉，活着的是primary和arbitor，本身arbitor只是投票，无实际数据；因此chunk migration的写关注majority无法完成。</p>
<pre><code>2018-03-28T09:00:17.630+0800 I REPL     [ReplicationExecutor] Error in heartbeat request to mongodb2:28000; HostUnreachable: Connection refused
2018-03-28T09:00:18.341+0800 I SHARDING [migrateThread] Waiting for replication to catch up before entering critical section
2018-03-28T09:00:19.347+0800 I SHARDING [migrateThread] Waiting for replication to catch up before entering critical section
2018-03-28T09:00:19.631+0800 I ASIO     [NetworkInterfaceASIO-Replication-0] Connecting to mongodb2:28000
/2018-03-28T09:05:35
2018-03-28T09:05:45.694+0800 I NETWORK  [thread2] connection accepted from 10.1.81.105:46057 #233777 (37 connections now open)
2018-03-28T09:05:45.695+0800 I NETWORK  [conn233777] received client metadata from 10.1.81.105:46057 conn233777: { driver: { name: &quot;NetworkInterfaceASIO-ShardRegistry&quot;, version: &quot;3.4.10&quot; }, os: { type: &quot;Linux&quot;, name: &quot;Red Hat Enterprise Linux Server release 6.5 (Santiago)&quot;, architecture: &quot;x86_64&quot;, version: &quot;Kernel 2.6.32-431.el6.x86_64&quot; } }
2018-03-28T09:05:46.020+0800 I SHARDING [conn233766] Refreshing chunks for collection mdgw.hq20171226 based on version 1|584||5a417565916709d86fdb67ea
2018-03-28T09:05:46.024+0800 I SHARDING [CatalogCacheLoader-15578] Refresh for collection mdgw.hq20171226 took 3 ms and found version 1|584||5a417565916709d86fdb67ea
2018-03-28T09:05:46.024+0800 I SHARDING [migrateThread] Starting receiving end of migration of chunk { SecurityID: MinKey } -&gt; { SecurityID: -9115002770324251294 } for collection mdgw.hq20171226 from shard1/10.1.81.104:28000,10.1.81.106:28001 at epoch 5a417565916709d86fdb67ea with session id shard1_shard3_5abaea69a678125edaf9de9c
2018-03-28T09:05:46.027+0800 I SHARDING [migrateThread] Deleter starting delete for: mdgw.hq20171226 from { SecurityID: MinKey } -&gt; { SecurityID: -9115002770324251294 }, with opId: 87092461
2018-03-28T09:05:46.057+0800 W SHARDING [migrateThread] aborting migration cleanup for chunk { : MinKey } to { : -9115002770324251294 } at document { _id: ObjectId(&apos;5a41912a886ede03c476ce4b&apos;), OrigTime: 20171226080042000, MDStreamID: &quot;010&quot;, SecurityID: &quot;000722.SZ&quot;, Symbol: &quot;&quot;, TradingPhaseCodeStd: &quot;&quot;, PrevClosePrice: 8.6300, OpenPrice: 0, HighPrice: 0, LowPrice: 0, LastPrice: 0, ClosePx: 0, TotalValueTraded: 0.0000, TotalVolumeTraded: 0.00, BuyPrice: [ 41.550000, 41.540000, 41.530000, 41.520000, 41.510000 ], BuyVolume: [ 1613461.00, 1500.00, 1500.00, 1500.00, 1500.00 ], SellPrice: [ 118.010000, 118.050000, 118.060000, 118.100000, 118.130000 ], SellVolume: [ 500.00, 500.00, 900.00, 1100.00, 100.00 ], PrevFundnav: 0, LastFundnav: 0, pe_1: 28.510000, p_highlimit: 9.490000, p_lowlimit: 7.770000 }, collection mdgw.hq20171226 has changed
2018-03-28T09:05:46.057+0800 I SHARDING [migrateThread] rangeDeleter deleted 0 documents for mdgw.hq20171226 from { SecurityID: MinKey } -&gt; { SecurityID: -9115002770324251294 }
2018-03-28T09:05:46.057+0800 W SHARDING [migrateThread] new pending chunk [{ SecurityID: MinKey }, { SecurityID: -9115002770324251294 }) overlaps existing pending chunks [{ SecurityID: MinKey }, { SecurityID: -9115002770324251294 }), a migration may not have completed
2018-03-28T09:05:50.649+0800 I SHARDING [migrateThread] Waiting for replication to catch up before entering critical section
2018-03-28T09:05:50.649+0800 I SHARDING [migrateThread] migrate commit succeeded flushing to secondaries for &apos;mdgw.hq20171226&apos; { SecurityID: MinKey } -&gt; { SecurityID: -9115002770324251294 }
2018-03-28T09:06:06.325+0800 I SHARDING [migrateThread] about to log metadata event into changelog: { _id: &quot;mongodb1-2018-03-28T09:06:06.325+0800-5abaea7e2a108a636fdbff5e&quot;, server: &quot;mongodb1&quot;, clientAddr: &quot;&quot;, time: new Date(1522199166325), what: &quot;moveChunk.to&quot;, ns: &quot;mdgw.hq20171226&quot;, details: { min: { SecurityID: MinKey }, max: { SecurityID: -9115002770324251294 }, step 1 of 6: 2, step 2 of 6: 30, step 3 of 6: 4591, step 4 of 6: 0, step 5 of 6: 15676, step 6 of 6: 0, note: &quot;success&quot; } }
2018-03-28T09:06:06.817+0800 I NETWORK  [thread2] connection accepted from 10.1.81.106:41502 #233778 (38 connections now open)
2018-03-28T09:06:06.817+0800 I NETWORK  [conn233778] received client metadata from 10.1.81.106:41502 conn233778: { driver: { name: &quot;NetworkInterfaceASIO-ShardRegistry&quot;, version: &quot;3.4.10&quot; }, os: { type: &quot;Linux&quot;, name: &quot;Red Hat Enterprise Linux Server release 6.5 (Santiago)&quot;, architecture: &quot;x86_64&quot;, version: &quot;Kernel 2.6.32-431.el6.x86_64&quot; } }
2018-03-28T09:06:06.818+0800 I COMMAND  [conn233778] CMD: drop mdgw.hq20171226
</code></pre><p>mongodb在moveChunk的时候会使用 _distributed lock_来确保任意的shard上只有1个迁移作业。<br>在mongodb里，drop分片集合的操作也需要获取_distributed lock_。<br>因此由于chunk migration一直由于majority无法完成，_distributed lock_持续被占用无法释放，所以drop操作等待到超时报错。</p>
<h2 id="解决-amp-建议"><a href="#解决-amp-建议" class="headerlink" title="解决&amp;建议"></a>解决&amp;建议</h2><ol>
<li>在将down掉的从节点拉起后，chunk migration完成并释放锁后，drop成功</li>
<li>在分片环境中，不要采用PSV的复制集架构，至少是1P2S的架构，保证chunk migration的正常进行。</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/10/MongoDB-Ops-Manager-Backup-Restore/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dbits">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dbits">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/10/MongoDB-Ops-Manager-Backup-Restore/" itemprop="url">MongoDB - Ops Manager Backup & Restore</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-10T11:36:42+08:00">
                2018-01-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MongoDB/" itemprop="url" rel="index">
                    <span itemprop="name">MongoDB</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/01/10/MongoDB-Ops-Manager-Backup-Restore/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/01/10/MongoDB-Ops-Manager-Backup-Restore/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Backup-Preparations"><a href="#Backup-Preparations" class="headerlink" title="Backup Preparations"></a>Backup Preparations</h2><h2 id="Backup-Process"><a href="#Backup-Process" class="headerlink" title="Backup Process"></a>Backup Process</h2><p>一旦开始，就是一个持续的过程，数据同步类似复制集</p>
<ol>
<li>initial sync 备份当前所有的数据 （包含所有的shard和config server）</li>
<li>按照快照计划（snapshot schedule）执行快照（data directory），并将快照传输到存储系统</li>
<li>持续监控oplog，将新的数据操作更新到Ops manager</li>
</ol>
<h2 id="Backup-Process-Flows"><a href="#Backup-Process-Flows" class="headerlink" title="Backup Process Flows"></a>Backup Process Flows</h2><h3 id="Initial-Backup"><a href="#Initial-Backup" class="headerlink" title="Initial Backup"></a>Initial Backup</h3><p><img src="https://docs.opsmanager.mongodb.com/current/_images/backup-flow.png" alt=""></p>
<ol>
<li>Backup Agent连接到mongod</li>
<li>starting阶段：开始初始化同步（initial sync），backup agent将数据按10MB（压缩）为单位的slice，传输到ops manager；备份时间点开始后的数据另外备份</li>
<li>transferring阶段：backup Daemon将slice传输到Oplog Store（临时的）</li>
<li>Backup agent同时抓取oplog，10MB（压缩）为单位的oplog slice</li>
<li>building阶段：所有的slice接收完毕，Ops manager创建本地的数据库副本（head database），head database位于运行backup Daemon的主机上</li>
<li>backup Daemon从Oplog Store读取数据，并插入head database</li>
<li>applying oplogs阶段：将oplog数据插入head database</li>
<li>fetching missing documents阶段：Ops Manager检查生产数据库，并将遗漏的数据插入head database</li>
<li>creating indexes阶段：在head database上按照生产数据库的信息创建index</li>
<li>定时创建快照备份数据库，快照存储的方式支持：Blockstore Database、AWS S3、File system</li>
</ol>
<blockquote>
<p>3和4同步进行</p>
</blockquote>
<h3 id="Subsequent-Backups"><a href="#Subsequent-Backups" class="headerlink" title="Subsequent Backups"></a>Subsequent Backups</h3><ol>
<li>Backup Agent抓取生产数据库的oplog</li>
<li>Backup Agnet将oplog slice发送到Ops Manager</li>
<li>将oplog slice存储在Oplog Store中</li>
<li>将新的oplog应用到head database</li>
<li>根据snapshot schedule定制执行快照</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/03/MongoDB-Ops-Manager-Overview/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dbits">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dbits">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/03/MongoDB-Ops-Manager-Overview/" itemprop="url">MongoDB - Ops Manager Overview</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-03T14:29:47+08:00">
                2018-01-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MongoDB/" itemprop="url" rel="index">
                    <span itemprop="name">MongoDB</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/01/03/MongoDB-Ops-Manager-Overview/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/01/03/MongoDB-Ops-Manager-Overview/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Ops-Manager概念"><a href="#Ops-Manager概念" class="headerlink" title="Ops Manager概念"></a>Ops Manager概念</h2><h3 id="Monitoring"><a href="#Monitoring" class="headerlink" title="Monitoring"></a>Monitoring</h3><ol>
<li>提供实时的报表、可视化、告警（数据库和系统性能）</li>
<li>轻量级的agent，不需要每台数据库服务器都安装</li>
</ol>
<h3 id="Automation"><a href="#Automation" class="headerlink" title="Automation"></a>Automation</h3><ol>
<li>用户配置MongoDB node或者cluster</li>
<li>automation agent每个数据库server上都要安装</li>
<li>automation agent管理monitor和backup agent</li>
</ol>
<h3 id="Backup"><a href="#Backup" class="headerlink" title="Backup"></a>Backup</h3><ol>
<li>提供基于任务计划的快照和任意时间点的恢复</li>
<li>必须是集群的环境才可以备份，standalone实例需要先转换为replica set</li>
</ol>
<h4 id="Data-Backup"><a href="#Data-Backup" class="headerlink" title="Data Backup"></a>Data Backup</h4><ol>
<li>backup agent会在复制集内创建一个新的invisble成员，做initial sync</li>
<li>backup agent使用tail的方式复制oplog到一个head database（每个replica set对应一个head database）</li>
<li>initial sync和tail oplog使用标准的MongoDB查询，生产库影响不大</li>
<li>备份使用的mongod版本要大于等于备份客户端</li>
</ol>
<p><em>分片环境内，通过mongos停止balancer，插入marker token，然后才会开始执行快照</em></p>
<table>
<thead>
<tr>
<th>Snapshot Store</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>MongoDB blockstore</td>
<td>Each successive snapshot stores only the differences from the previous snapshot. Compression and block-level de-duplication reduce the size of snapshot data.</td>
</tr>
<tr>
<td>AWS S3 bucket</td>
<td>Each successive snapshot stores only the differences from the previous snapshot. Compression and block-level de-duplication reduce the size of snapshot data.</td>
</tr>
<tr>
<td>File system store</td>
<td>Depending on the configuration, compression reduces the size of the snapshot data.</td>
</tr>
</tbody>
</table>
<h4 id="Data-Restoration"><a href="#Data-Restoration" class="headerlink" title="Data Restoration"></a>Data Restoration</h4><ul>
<li>分片环境，可以恢复到2个snapshot之间的checkpoint点</li>
<li>复制集，可以恢复到任意时间点</li>
</ul>
<h3 id="Server-Pool"><a href="#Server-Pool" class="headerlink" title="Server Pool"></a>Server Pool</h3><p>如果已经在服务器上部署了automation agent，可以通过osp上的管理员权限用户自动部署MongoDB数据库</p>
<h2 id="Ops-Manager架构"><a href="#Ops-Manager架构" class="headerlink" title="Ops Manager架构"></a>Ops Manager架构</h2><ol>
<li>host running ops manager</li>
<li>host store application data （application database）</li>
<li>host store snapshots</li>
</ol>
<h3 id="Ops-Manager-Application"><a href="#Ops-Manager-Application" class="headerlink" title="Ops Manager Application"></a>Ops Manager Application</h3><p>默认端口8080，可以多个application使用同一个配置和database</p>
<h3 id="Backup-Daemon-Service"><a href="#Backup-Daemon-Service" class="headerlink" title="Backup Daemon Service"></a>Backup Daemon Service</h3><ol>
<li>backup Daemon服务管理备份的快照和local copy</li>
<li>local copy称为head database</li>
<li>backup Daemon将head database存放在head directory目录下，将snapshot存放在snapshot store下</li>
<li>backup Daemon所在的主机会创建一个invisible的成员</li>
<li>多个Backup Daemon可以水平扩展存储并且提供手工failover</li>
</ol>
<h3 id="Dedicated-Storage-for-Operational-Data"><a href="#Dedicated-Storage-for-Operational-Data" class="headerlink" title="Dedicated Storage for Operational Data"></a>Dedicated Storage for Operational Data</h3><h4 id="Ops-Manager-Application-Database"><a href="#Ops-Manager-Application-Database" class="headerlink" title="Ops Manager Application Database"></a>Ops Manager Application Database</h4><ol>
<li>建议使用复制集保存数据</li>
<li>保存两类数据：监控数据 、 Metadata信息</li>
</ol>
<h4 id="Snapshot-Storage"><a href="#Snapshot-Storage" class="headerlink" title="Snapshot Storage"></a>Snapshot Storage</h4><ol>
<li>local database</li>
<li>local file systems</li>
<li>cloud-based data store</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/03/MongoDB-3-4-Storage-Engine/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dbits">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dbits">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/03/MongoDB-3-4-Storage-Engine/" itemprop="url">MongoDB 3.4 - Storage Engine</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-03T10:19:19+08:00">
                2018-01-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MongoDB/" itemprop="url" rel="index">
                    <span itemprop="name">MongoDB</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/01/03/MongoDB-3-4-Storage-Engine/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/01/03/MongoDB-3-4-Storage-Engine/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="WT-Engine"><a href="#WT-Engine" class="headerlink" title="WT Engine"></a>WT Engine</h2><ol>
<li>3.0开始，WT在64bit的MongoDB上可用</li>
<li>3.2开始，WT作为MongoDB的默认存储引擎</li>
<li>WT提供压缩功能，支持文档级别的锁</li>
</ol>
<h3 id="Snapshot-amp-Checkpoint"><a href="#Snapshot-amp-Checkpoint" class="headerlink" title="Snapshot &amp; Checkpoint"></a>Snapshot &amp; Checkpoint</h3><ol>
<li>60s或者journal log &gt; 2G,触发checkpoint，将data files的一致性数据写入磁盘</li>
<li>在将snapshot刷新入disk时，前一个checkpint还是valid状态</li>
<li>如果在此时发生错误，可以从前一个checkpoint恢复</li>
<li>如果写入后发生错误，可以从最近一个checkpoint恢复，再使用journal log将checkpoint后的数据recover</li>
</ol>
<h3 id="Journal"><a href="#Journal" class="headerlink" title="Journal"></a>Journal</h3><ol>
<li>journal是write-ahead transaction log</li>
<li>记录两次checkpoint之间的数据，保证能够在数据库发生错误后使用snapshot和journal将数据库恢复到故障前的状态</li>
<li>WT默认使用snappy机制压缩journal log</li>
<li>默认的buffer大小128kB，</li>
<li>&lt;128byte的log record,不压缩</li>
<li>journal file在MMAPv1要和datafile放在一个路径下面，</li>
</ol>
<h3 id="journal-sync条件"><a href="#journal-sync条件" class="headerlink" title="journal sync条件"></a>journal sync条件</h3><ul>
<li>50ms （3.2 WT） 100ms（MMAPV1）</li>
<li>j:true会触发</li>
<li>checkpoint （60s或者&gt;2G）</li>
<li>journal file切换 (每个journal file是100MB）</li>
</ul>
<h3 id="Compression"><a href="#Compression" class="headerlink" title="Compression"></a>Compression</h3><ol>
<li>WT支持对collection和index的压缩，消耗更多CPU</li>
<li>默认使用snappy压缩算法，block级别的压缩</li>
<li>可以对单个collection或者index设置压缩</li>
</ol>
<h3 id="内存的使用"><a href="#内存的使用" class="headerlink" title="内存的使用"></a>内存的使用</h3><ol>
<li>MongoDB使用WT internal cache和file system cache</li>
<li>WT默认大小：物理内存 * 50% - 1GB 或者 256MB</li>
<li>filesystem cache用于降低disk I/O，数据在file system cache里的格式和disk上是一样的</li>
<li>索引在WT cache里的格式和disk上的是不一样的，但是一样可以使用prefix index压缩降低内存使用量</li>
<li>collection的数据在WT cache里是没有压缩的，数据在WT内的操作要先解压</li>
<li>除WT cache和其他系统使用掉的内存，MongoDB会使用剩余的所有内存作为file system cache</li>
</ol>
<h2 id="MMAPV1"><a href="#MMAPV1" class="headerlink" title="MMAPV1"></a>MMAPV1</h2><h3 id="Power-of-2-Sized-Allocations"><a href="#Power-of-2-Sized-Allocations" class="headerlink" title="Power of 2 Sized Allocations"></a>Power of 2 Sized Allocations</h3><ol>
<li>如果更新后文档不能在预先分配的空间内存下，则需要move到其他地方，同时更新索引，引起性能开销，并且带来碎片化</li>
<li>3.0 每个文档的尺寸大小为2的整数倍</li>
<li>对于insert only的数据，记录大小不会增长，可以关闭power of 2，使用collMod命令，参数noPadding</li>
<li>MMAPv1使用系统所有的剩余内存，内存使用是动态的，如果有其他的进程需要使用系统内存，MongoDB会让出一部分内存</li>
</ol>
<h3 id="Memory-use"><a href="#Memory-use" class="headerlink" title="Memory use"></a>Memory use</h3><ol>
<li>mem.resident 目前正在使用的内存大小</li>
<li>mem.mapped mongod使用的map的内存大小，如果比实际内存要大很多，可能会发生page fault</li>
</ol>
<h3 id="page-fault"><a href="#page-fault" class="headerlink" title="page fault"></a>page fault</h3><ol>
<li>当读取的数据，或者写入的数据文件没有map到内存上，会发生page fault</li>
<li>extra_info.page_faults</li>
</ol>
<h3 id="Summary-of-Major-Differences-between-MMAPv1-and-WiredTiger"><a href="#Summary-of-Major-Differences-between-MMAPv1-and-WiredTiger" class="headerlink" title="Summary of Major Differences between MMAPv1 and WiredTiger"></a>Summary of Major Differences between MMAPv1 and WiredTiger</h3><h4 id="Locks-Concurrency"><a href="#Locks-Concurrency" class="headerlink" title="Locks/Concurrency"></a>Locks/Concurrency</h4><ul>
<li>MMAPv1 uses collection level locking in MongoDB 3.0</li>
<li>WiredTiger supports document-level concurrency</li>
</ul>
<h4 id="Journaling"><a href="#Journaling" class="headerlink" title="Journaling"></a>Journaling</h4><ul>
<li>Journaling is recommended for both MMAPv1 and WiredTiger</li>
<li>For MMAPv1, it ensures that writes are atomic</li>
<li>For WT, it ensures that writes make it to disk between checkpoints</li>
</ul>
<h4 id="Data-Compression"><a href="#Data-Compression" class="headerlink" title="Data Compression"></a>Data Compression</h4><ul>
<li>WiredTiger supports both the snappy and zlib compression algorithms</li>
<li>MMAPv1 does not support data compression</li>
</ul>
<h4 id="Other-Considerations"><a href="#Other-Considerations" class="headerlink" title="Other Considerations"></a>Other Considerations</h4><ul>
<li>Due to the way MMAPv1 organizes data, if a BSON document outgrows its allotted space, it must be moved. Indexes that point to this document point to its file offset and will need to be updated. As a consequence, writes that force a document to move on disk come at a relatively high performance cost. Document movement also leads to fragmentation.</li>
<li>To minimize document movement, MMAPv1 uses a power-of-two size allocation strategy, allocating a “record space” to each document that is larger than the document. If the document outgrows its record space, the newly allocated space for the document will be twice as large as the previous allocation. Power-of-two sizing also enables the storage engine to more easily reuse space vacated by a moved document, because all document allocations will be a size that is a power of two.</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/03/MongoDB-3-4-Diagnostics-and-Debugging/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dbits">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dbits">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/03/MongoDB-3-4-Diagnostics-and-Debugging/" itemprop="url">MongoDB 3.4 - Diagnostics and Debugging</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-03T10:17:46+08:00">
                2018-01-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MongoDB/" itemprop="url" rel="index">
                    <span itemprop="name">MongoDB</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/01/03/MongoDB-3-4-Diagnostics-and-Debugging/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/01/03/MongoDB-3-4-Diagnostics-and-Debugging/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="server-log"><a href="#server-log" class="headerlink" title="server log"></a>server log</h2><ol>
<li>遇到问题先看log</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;timestamp&gt; &lt;severity&gt; &lt;component&gt; [&lt;context&gt;] &lt;message&gt;</span><br></pre></td></tr></table></figure>
<h3 id="修改log的级别"><a href="#修改log的级别" class="headerlink" title="修改log的级别"></a>修改log的级别</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.getLogComponents()</span><br><span class="line">db.setLogLevel(-1, &quot;query&quot;)</span><br></pre></td></tr></table></figure>
<h3 id="logrotate"><a href="#logrotate" class="headerlink" title="logrotate"></a>logrotate</h3><p>–logRotate默认参数是rename，会在原来的日志文件后面加上一个时间戳，如果使用参数reopen，则必须指定参数–logappend<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.adminCommand( &#123; logRotate : 1 &#125; )</span><br></pre></td></tr></table></figure></p>
<h2 id="db-serverStatus"><a href="#db-serverStatus" class="headerlink" title="db.serverStatus()"></a>db.serverStatus()</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">&gt; Object.keys(db.serverStatus())</span><br><span class="line">[</span><br><span class="line">        &quot;host&quot;,</span><br><span class="line">        &quot;version&quot;,</span><br><span class="line">        &quot;process&quot;,</span><br><span class="line">        &quot;pid&quot;,</span><br><span class="line">        &quot;uptime&quot;,</span><br><span class="line">        &quot;uptimeMillis&quot;,</span><br><span class="line">        &quot;uptimeEstimate&quot;,</span><br><span class="line">        &quot;localTime&quot;,</span><br><span class="line">        &quot;asserts&quot;,</span><br><span class="line">        &quot;connections&quot;,</span><br><span class="line">        &quot;extra_info&quot;,</span><br><span class="line">        &quot;globalLock&quot;,</span><br><span class="line">        &quot;locks&quot;,</span><br><span class="line">        &quot;network&quot;,</span><br><span class="line">        &quot;opLatencies&quot;,</span><br><span class="line">        &quot;opcounters&quot;,</span><br><span class="line">        &quot;opcountersRepl&quot;,</span><br><span class="line">        &quot;storageEngine&quot;,</span><br><span class="line">        &quot;tcmalloc&quot;,</span><br><span class="line">        &quot;wiredTiger&quot;,</span><br><span class="line">        &quot;mem&quot;,</span><br><span class="line">        &quot;metrics&quot;,</span><br><span class="line">        &quot;ok&quot;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># for loop that iterates over few documents with a sleep</span><br><span class="line">mongo --eval &apos; while(true) &#123; for (i=1; i&lt;=10; i++)&#123;</span><br><span class="line">  db.things.insertOne(&#123;&#125;); sleep(1000);</span><br><span class="line">&#125;&#125; &apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; db.serverStatus().localTime</span><br><span class="line">ISODate(&quot;2017-10-26T07:55:44.169Z&quot;)</span><br><span class="line"></span><br><span class="line">&gt; db.serverStatus().locks</span><br><span class="line">&#123;</span><br><span class="line">        &quot;Global&quot; : &#123;</span><br><span class="line">                &quot;acquireCount&quot; : &#123;</span><br><span class="line">                        &quot;r&quot; : NumberLong(2340),</span><br><span class="line">                        &quot;w&quot; : NumberLong(7),</span><br><span class="line">                        &quot;W&quot; : NumberLong(3)</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Database&quot; : &#123;</span><br><span class="line">                &quot;acquireCount&quot; : &#123;</span><br><span class="line">                        &quot;r&quot; : NumberLong(767),</span><br><span class="line">                        &quot;R&quot; : NumberLong(11),</span><br><span class="line">                        &quot;W&quot; : NumberLong(7)</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Collection&quot; : &#123;</span><br><span class="line">                &quot;acquireCount&quot; : &#123;</span><br><span class="line">                        &quot;r&quot; : NumberLong(767)</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Metadata&quot; : &#123;</span><br><span class="line">                &quot;acquireCount&quot; : &#123;</span><br><span class="line">                        &quot;w&quot; : NumberLong(1)</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>R:shared lock; W: exclusive lock; r: intent shared lock; w: intent exclusive lock</p>
<p>opcounters只记录操作数，不包含受影响的document统计；metrics.document包含操作影响到的document</p>
<p>db.serverStatus().globalLock.totalTime如果和uptime接近，表示数据库一直有锁的性能问题</p>
<p>db.serverStatus().globalLock.currentQueue.total 表示实时的锁统计信息  </p>
</blockquote>
<h2 id="profiler"><a href="#profiler" class="headerlink" title="profiler"></a>profiler</h2><ul>
<li>针对数据库级别的，非整个mongod server</li>
<li>{0:off,1:slow,2:whole}</li>
<li>db.system.profile 是一个capped集合，默认大小1m</li>
<li>默认slow operation阀值100ms</li>
<li>不能在mongos打开profiler，需要在cluster内的每个mongod上操作</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;db.setProfilingLevel(2)</span><br><span class="line">&gt;db.system.profile.find().pretty()</span><br><span class="line">&gt;db.system.profile.find().sort(&#123;$natural: -1&#125;).limit(1).pretty()</span><br><span class="line">&gt;db.getProfilingStatus()</span><br><span class="line">&gt;db.system.profile.aggregate( [ &#123; $group : &#123;_id : &quot;$op&quot;, count : &#123; $sum : 1&#125;&#125;&#125;])</span><br></pre></td></tr></table></figure>
<h2 id="indexStats"><a href="#indexStats" class="headerlink" title="indexStats"></a>indexStats</h2><ol>
<li>可以使用$indeStats查看哪些索引没有被使用</li>
<li>复制集内的各节点单独计数</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.people.aggregate( [ &#123; $indexStats : &#123; &#125; &#125; ] ).pretty()</span><br><span class="line"></span><br><span class="line">db.people.aggregate( [</span><br><span class="line">  &#123; $indexStats : &#123; &#125; &#125;,</span><br><span class="line">  &#123; $project : &#123; key: 1, &quot;accesses.ops&quot;: 1 &#125; &#125;</span><br><span class="line">] ).pretty()</span><br></pre></td></tr></table></figure>
<h2 id="慢查询"><a href="#慢查询" class="headerlink" title="慢查询"></a>慢查询</h2><h3 id="导致的因素"><a href="#导致的因素" class="headerlink" title="导致的因素:"></a>导致的因素:</h3><ol>
<li>working set大小超过内存</li>
</ol>
<h2 id="mtools"><a href="#mtools" class="headerlink" title="mtools"></a>mtools</h2><h3 id="mloginfo"><a href="#mloginfo" class="headerlink" title="mloginfo"></a>mloginfo</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">mloginfo --queries --no-progressbar mongodb.log</span><br><span class="line">     source: mongodb.log</span><br><span class="line">       host: dc1custdb06:27000</span><br><span class="line">      start: 2017 Oct 25 20:04:16.308</span><br><span class="line">        end: 2017 Oct 26 10:41:55.182</span><br><span class="line">date format: iso8601-local</span><br><span class="line">     length: 237443</span><br><span class="line">     binary: mongod</span><br><span class="line">    version: 3.4.6</span><br><span class="line">    storage: wiredTiger</span><br><span class="line"></span><br><span class="line">QUERIES</span><br><span class="line">namespace                          operation    pattern                                 count    min (ms)    max (ms)    mean (ms)    95%-ile (ms)    sum (ms)</span><br><span class="line"></span><br><span class="line">mucem.metricData                   find         &#123;&quot;dataType&quot;: 1, &quot;metricData&quot;: 1&#125;        64956         100     1314642         2826          2273.0    183600980</span><br><span class="line">mucem.individual                   find         &#123;&quot;indivCerts.certNum&quot;: 1&#125;                4883         100       93637         1773          9577.9    8662154</span><br><span class="line">mucem.mumobileAccount              find         &#123;&quot;lstUpdTime&quot;: 1, &quot;prcSts&quot;: 1&#125;            685         120     1548426         5301          2878.2    3631317</span><br><span class="line">mucem.muAppUserInfo                find         &#123;&quot;_id&quot;: 1&#125;                                438         110       52225         5786        17874.15    2534591</span><br><span class="line">mucem.individual                   find         &#123;&quot;memberships.memshpCardNo&quot;: 1&#125;          1165         100       94250         2051          9986.2    2389683</span><br><span class="line">local.clustermanager               find         None                                      435         100       52231         4706         16964.0    2047117</span><br><span class="line">mucem.mumobileAccount              find         &#123;&quot;_id&quot;: 1&#125;                                269         100       83832         7591         28043.0    2042084</span><br><span class="line">mucem.muAppUserInfo                find         &#123;&quot;lstUpdTime&quot;: 1, &quot;prcSts&quot;: 1&#125;            122         100      278448        16023        69047.45    1954891</span><br><span class="line">mucem.paxEvt                       find         &#123;&quot;lstUpdTime&quot;: 1, &quot;paxEvtPrcSts&quot;: 1&#125;      180         101     1198138        10065         1916.25    1811708</span><br><span class="line">mucem.abnorFltEvt                  find         &#123;&quot;abnorFltEvtPrcSts&quot;: 1&#125;                   82         102      208458        17830         88588.7    1462116</span><br><span class="line">mucem.mumobileAccount              find         &#123;&quot;crtTime&quot;: &#123;&quot;$ne&quot;: 1&#125;&#125;                   125         242      708768        11449         10282.2    1431224</span><br><span class="line">mucemcustprofilepsdp.individual    count        &#123;&quot;mobiles.numBody&quot;: 1&#125;                    456         100      248685         3001        12686.75    1368538</span><br><span class="line">mucemcustprofilepsdp.metricData    find         &#123;&quot;dataType&quot;: 1, &quot;metricData&quot;: 1&#125;          283         100       56042         3085         17011.3    873298</span><br><span class="line">local.system.replset               find         None                                      100         102       34156         6839        18707.45    683970</span><br><span class="line">mucem.individual                   update       &#123;&quot;_id&quot;: 1&#125;                               2021         100        5554          138           198.0    280099</span><br><span class="line">mucem.individual                   count        &#123;&quot;mobiles.numBody&quot;: 1&#125;                    188         100       39015         1468         6539.15    276109</span><br><span class="line">admin.system.users                 find         &#123;&#125;                                         43         103       22636         4455         13284.6    191586</span><br><span class="line">local.oplog.rs                     getmore      None                                        1       60444       60444        60444         60444.0    60444</span><br><span class="line">mucem.labelLibraryData             update       &#123;&quot;_id&quot;: 1&#125;                                 89         101        5565          629          5500.0    56042</span><br><span class="line">mucem.custDtl                      update       &#123;&quot;_id&quot;: 1&#125;                                 80         100        5541          690          5529.1    55249</span><br><span class="line">mucem.custMonth                    find         &#123;&quot;indvlCardNbr&quot;: 1&#125;                       147         100        5555          156           175.7    23071</span><br><span class="line">mucem.custDtl                      find         &#123;&quot;lstUpdTime&quot;: 1, &quot;status&quot;: 1&#125;             85         100        5552          256           196.6    21809</span><br><span class="line">mucem.custDest                     find         &#123;&quot;indvlCardNbr&quot;: 1&#125;                       114         100        5554          171           186.8    19567</span><br><span class="line">mucem.muAppUserInfo                find         None                                        8         118       13605         2196          9923.0    17571</span><br><span class="line">mucem.paxEvt                       update       &#123;&quot;_id&quot;: 1&#125;                                 68         101        5533          255          486.95    17358</span><br><span class="line">mucem.custOrig                     find         &#123;&quot;indvlCardNbr&quot;: 1&#125;                       132         100         263          118           188.5    15700</span><br><span class="line">mucem.individual                   update       &#123;&quot;custId&quot;: 1&#125;                              38         100        5573          408         1050.85    15534</span><br><span class="line">mucem.custLine                     find         &#123;&quot;indvlCardNbr&quot;: 1&#125;                       122         100         218          120           182.9    14710</span><br><span class="line">mucem.labelLibraryData             find         &#123;&quot;lstUpdTime&quot;: 1, &quot;status&quot;: 1&#125;             24         102        5549          597          4749.4    14335</span><br><span class="line">mucem.custAircraft                 find         &#123;&quot;indvlCardNbr&quot;: 1&#125;                       111         100         231          127           222.0    14128</span><br><span class="line">mucem.muAppUserInfo                update       &#123;&quot;_id&quot;: 1&#125;                                 69         100        4006          179           178.2    12381</span><br><span class="line">mucem.individual                   find         &#123;&quot;mobiles.numBody&quot;: 1&#125;                     28         105        1845          425          1538.2    11923</span><br><span class="line">mucem.mumobileAccount              update       &#123;&quot;_id&quot;: 1&#125;                                 18         105         511          300           483.8    5414</span><br><span class="line">mucemcustprofilepsdp.metricData    update       &#123;&quot;_id&quot;: 1&#125;                                  3         106         225          150           214.6    452</span><br><span class="line">local.oplog.rs                     find         &#123;&quot;ts&quot;: 1&#125;                                   1         162         162          162           162.0    162</span><br><span class="line">mucem.metricData                   update       &#123;&quot;_id&quot;: 1&#125;                                  1         107         107          107           107.0    107</span><br></pre></td></tr></table></figure>
<h3 id="mplotqueries"><a href="#mplotqueries" class="headerlink" title="mplotqueries"></a>mplotqueries</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mplotqueries mongodb.log</span><br></pre></td></tr></table></figure>
<h3 id="mlogvis"><a href="#mlogvis" class="headerlink" title="mlogvis"></a>mlogvis</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mlogvis --no-browser mongodb.log</span><br></pre></td></tr></table></figure>
<h2 id="timeout"><a href="#timeout" class="headerlink" title="timeout"></a>timeout</h2><ol>
<li>serverSelectionTimeoutError: 发生在client端，当没有可用的server时候</li>
<li>WTimeoutError： db.foo.insertOne({hello : ‘world’}, {writeConcern : {w : 3, wtimeout : 2}) 如果2ms内没有完成，写入还是会做，但是会报错。</li>
<li>ExecutionTimeout: cursor parameter,如果在规定时间内没有执行完成，返回错误; db.collection.find({})._addSpecial(“$maxTimes”, 100)</li>
<li>networkTimeout： 和网络配置相关</li>
</ol>
<h2 id="closing-and-dropping-connections"><a href="#closing-and-dropping-connections" class="headerlink" title="closing and dropping connections"></a>closing and dropping connections</h2><ol>
<li>连接比较占用虚拟内存 mongostat里面的vsize，每个连接占用1M内存</li>
<li>default max incoming connection 65536</li>
<li>配置文件里可以使用maxIncomingConnections设置</li>
<li>ulimit -a里面的openfile会对连接数有影响；connection、index、collection都是一个文件</li>
<li>db.serverStatus().connection的数量和ulimit -a有关系</li>
</ol>
<h2 id="write-concern-w-majority"><a href="#write-concern-w-majority" class="headerlink" title="write concern(w: majority)"></a>write concern(w: majority)</h2><ol>
<li>3节点，如果有一个投票节点，data secondary节点发生故障的时候则写入会报错WriteConcernFailed，但是数据还是会写入</li>
<li>3节点，如果有一个延迟节点，uptodate节点发生故障的时候则写入会报错WriteConcernFailed，但是数据还是会写入</li>
<li>不要依赖于arbiter和delay节点作为write concern</li>
</ol>
<h2 id="schema-issue"><a href="#schema-issue" class="headerlink" title="schema issue"></a>schema issue</h2><ol>
<li>找出是否有集合扫描</li>
</ol>
<pre><code>db.setProfilingLevel(2)
db.setProfilingLevel(0)
db.system.profile.count()
db.system.profile.find({}, {planSummary: 1})
db.system.profile.find({}, {planSummary: 1, op: 1, query: 1, ns: 1}).pretty()
db.system.profile.aggregate([ {$group : { _id : {op : &quot;$op&quot;, ns : &quot;$ns&quot;}}} ])
</code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/03/MongoDB-3-4-Backup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dbits">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dbits">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/03/MongoDB-3-4-Backup/" itemprop="url">MongoDB 3.4 - Backup</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-03T10:15:45+08:00">
                2018-01-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MongoDB/" itemprop="url" rel="index">
                    <span itemprop="name">MongoDB</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/01/03/MongoDB-3-4-Backup/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/01/03/MongoDB-3-4-Backup/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="备份单个server或者replicatset的方法"><a href="#备份单个server或者replicatset的方法" class="headerlink" title="备份单个server或者replicatset的方法"></a>备份单个server或者replicatset的方法</h2><ol>
<li>mongodump</li>
<li>filesystem snapshot</li>
<li>backup from secondary (shutdown - copy file - startup)</li>
</ol>
<h3 id="mongodump"><a href="#mongodump" class="headerlink" title="mongodump"></a>mongodump</h3><ol>
<li>备份全部或者单个database（不会备份local database），–oplog</li>
<li>用mongorestore恢复，–oplogreplay,需要有resotre的role，如果被恢复的备份含有system.profile,但是目标数据库上没有，会创建system.profile，但是不会恢复数据</li>
<li>产生的是BSON文件，对于小的数据库比较适用</li>
<li>mongodump只备份document，但是mongorestore在恢复完数据后会rebuild索引</li>
<li>mongodump会影响数据库性能，如果数据库很大，可能会消耗光内存产生page fault</li>
</ol>
<h3 id="文件系统快照"><a href="#文件系统快照" class="headerlink" title="文件系统快照"></a>文件系统快照</h3><ol>
<li>使用lvm或者存储的快照机制</li>
<li>开启journal</li>
<li>db.fsyncLock()–把数据flush到磁盘，禁止写入新的数据 – snapshot – db.fsyncUnlock(); 这个期间可能无法对数据库进行查询</li>
</ol>
<blockquote>
<p>注意：在使用db.fsyncLock()期间，不要断开session，否则可能会无法重新连接到数据库</p>
</blockquote>
<h3 id="备份sharded-cluster"><a href="#备份sharded-cluster" class="headerlink" title="备份sharded cluster"></a>备份sharded cluster</h3><ol>
<li>关闭balancer  sh.stopBalancer(),如果在进行chunk migration，需要等待结束</li>
<li>备份config database  mongodump –db config</li>
<li>备份每一个分片</li>
<li>开启balancer </li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># back up a shard cluster</span><br><span class="line"></span><br><span class="line">mongo --host 	some_mongos --eval &quot;sh.stopBalancer()&quot;</span><br><span class="line"># make sure that worked!</span><br><span class="line"></span><br><span class="line"># back up config database / a config server</span><br><span class="line">mongdump --host some_mongos_or_config_server --db config</span><br><span class="line"></span><br><span class="line"># back up all shards</span><br><span class="line">mongodump --host shard1_svr1 --oplog /backups/cluster1/shard1</span><br><span class="line">mongodump --host shard2_svr1 --oplog /backups/cluster1/shard2</span><br><span class="line">mongodump --host shard3_svr1 --oplog /backups/cluster1/shard3</span><br><span class="line">mongodump --host shard4_svr1 --oplog /backups/cluster1/shard4</span><br><span class="line">mongodump --host shard5_svr1 --oplog /backups/cluster1/shard5</span><br><span class="line">mongodump --host shard6_svr1 --oplog /backups/cluster1/shard6</span><br><span class="line"></span><br><span class="line"># balancer back on</span><br><span class="line">mongo --host some_mongos --eval &quot;sh.startBalancer()&quot;</span><br></pre></td></tr></table></figure>
<h2 id="一些特性"><a href="#一些特性" class="headerlink" title="一些特性"></a>一些特性</h2><h3 id="capped-collections"><a href="#capped-collections" class="headerlink" title="capped collections"></a>capped collections</h3><ol>
<li>circle queue</li>
<li>least-recently-insert order</li>
<li>preallocated max size</li>
<li>can’t delete or grow</li>
</ol>
<h3 id="TTL-Collections"><a href="#TTL-Collections" class="headerlink" title="TTL Collections"></a>TTL Collections</h3><ol>
<li>auto ageout of documents</li>
<li>create special index</li>
</ol>
<h3 id="Grid-FS"><a href="#Grid-FS" class="headerlink" title="Grid FS"></a>Grid FS</h3><ol>
<li>BSON file size limited 16MB<br>`</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/03/MongoDB-3-4-Scalability/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dbits">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dbits">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/03/MongoDB-3-4-Scalability/" itemprop="url">MongoDB 3.4 - Scalability</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-03T10:15:00+08:00">
                2018-01-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MongoDB/" itemprop="url" rel="index">
                    <span itemprop="name">MongoDB</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/01/03/MongoDB-3-4-Scalability/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/01/03/MongoDB-3-4-Scalability/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="sharding-amp-data-distribute"><a href="#sharding-amp-data-distribute" class="headerlink" title="sharding &amp; data distribute"></a>sharding &amp; data distribute</h3><p>分片的好处：</p>
<ol>
<li>查询（落在分片上，可以直接读取对应的分片）</li>
<li>排序</li>
</ol>
<h3 id="chunks"><a href="#chunks" class="headerlink" title="chunks"></a>chunks</h3><ul>
<li>chunks的默认大小64M</li>
<li>step1 split chunk的大小超过限制后，分裂为2个chunk，但是还在原来的分片上； step2 migrate 均衡chunks在分片上的数量</li>
<li>chunk size 小，migrate多，数据在分片上分布更均匀，但是对config server的开销越大； chunk size 大，migrate少，数据在分片上分布可能不太均衡</li>
<li>连续的chunks不保证在一个shard上</li>
<li>修改chunk size (1-1024M)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">connect to mongos</span><br><span class="line">use config</span><br><span class="line">db.settings.save( &#123; _id:&quot;chunksize&quot;, value: &lt;sizeInMB&gt; &#125; )</span><br></pre></td></tr></table></figure>
<h3 id="chunk-migration"><a href="#chunk-migration" class="headerlink" title="chunk migration"></a>chunk migration</h3><ol>
<li>手工：在bulk write之前手动migration</li>
<li>自动：blancer进程在触发阀值后执行migration（\<20 2;="" 20-79="" 4;="" \="">80 8）</20></li>
<li>sh.isBalancerRunning(）</li>
<li>balance进程运行在primary config server上，3.4之前只能有一个migration进程，3.4开始，可以有n/2个（n代表shards的数量）</li>
</ol>
<h3 id="Config-Server"><a href="#Config-Server" class="headerlink" title="Config Server"></a>Config Server</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use config</span><br><span class="line">show collections</span><br></pre></td></tr></table></figure>
<p>可以将mongos的端口指定为27017<br>admin数据库含有集群用户认证信息<br>config数据库包含集群的metadata信息</p>
<h3 id="mongos"><a href="#mongos" class="headerlink" title="mongos"></a>mongos</h3><ol>
<li>sort操作在primary shard上进行，3.2开始，aggr操作可以在任意的shard上进行</li>
<li>db.isMaster() 反回的”msg” : “isdbgrid”表示连接的是mongos</li>
<li>sort：每个分片进行$orderby，primary shard最后进行merge sort</li>
<li>limits：每个分片limit，最后所有的结果再limit，之后返回结果</li>
<li>skips：不会将skips传递给单个分片，只是最后结果skip</li>
</ol>
<h3 id="shard-key"><a href="#shard-key" class="headerlink" title="shard key"></a>shard key</h3><ol>
<li>经常用于查询的feild</li>
<li>高基数的字段</li>
<li>使用组合字段作为shardkey</li>
<li>递增字段（查询：分散IO到不同的分片上，写入：一直在最后一个分片上） ，BSON objectID递增，使用reverse_id,转化为随机的，或者hash</li>
<li>非空的集合做分片，必须有一个片键开始的索引</li>
<li>hash分片只能创建在单独的一个field上</li>
<li>You cannot select a different shard key for that collection.</li>
<li>You cannot update the values of the shard key fields.</li>
<li>hash分片只能用在单个field上，分片更均匀，但是牺牲了Query Isolation。</li>
</ol>
<blockquote>
<p>没有shard的database，一般默认放在primary shard，挑选一个数据量最小的分片做为primary shard，可以使用movePrimary移动数据库，但是会影响数据访问</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; db.adminCommand( &#123; listDatabases: 1 &#125; )</span><br><span class="line">&#123;</span><br><span class="line">    &quot;databases&quot; : [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;name&quot; : &quot;test&quot;,</span><br><span class="line">            &quot;sizeOnDisk&quot; : 65536,</span><br><span class="line">            &quot;empty&quot; : false,</span><br><span class="line">            &quot;shards&quot; : &#123;</span><br><span class="line">                &quot;shard01&quot; : 65536</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;name&quot; : &quot;admin&quot;,</span><br><span class="line">            &quot;sizeOnDisk&quot; : 114688,</span><br><span class="line">            &quot;empty&quot; : false</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;name&quot; : &quot;config&quot;,</span><br><span class="line">            &quot;sizeOnDisk&quot; : 503808,</span><br><span class="line">            &quot;empty&quot; : false</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;totalSize&quot; : 684032,</span><br><span class="line">    &quot;totalSizeMb&quot; : 0,</span><br><span class="line">    &quot;ok&quot; : 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="shard-key-index"><a href="#shard-key-index" class="headerlink" title="shard key index"></a>shard key index</h3><ol>
<li>分片的collection必须有一个shard key的索引（index、compound index with prefix）</li>
<li>分片的集合，只有_id和片键可以有唯一索引，其他字段不能有唯一索引（因为索引都是local创建的，没办法保证cluster范围内唯一）</li>
</ol>
<h3 id="shard限制"><a href="#shard限制" class="headerlink" title="shard限制"></a>shard限制</h3><ol>
<li>group | db.eval() | $where | $isolated | $snapshot | geoSearch</li>
<li>updateOne() removeOne() deleteOne()必须在查询条件中包含shard key或_id</li>
</ol>
<h3 id="config-server-HA"><a href="#config-server-HA" class="headerlink" title="config server HA"></a>config server HA</h3><ol>
<li>如果config server没能选出primary，任然可以对分片读写，但是chunk的migration和split无法进行</li>
<li>数据保存在config数据库内，要备份！！！！</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/03/MongoDB-3-4-replication/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dbits">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dbits">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/03/MongoDB-3-4-replication/" itemprop="url">MongoDB 3.4 - replication</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-03T10:13:38+08:00">
                2018-01-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MongoDB/" itemprop="url" rel="index">
                    <span itemprop="name">MongoDB</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/01/03/MongoDB-3-4-replication/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/01/03/MongoDB-3-4-replication/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="replication"><a href="#replication" class="headerlink" title="replication"></a>replication</h1><ul>
<li>statement based replication set(非binary)，所以复制集内MongoDB的版本可以不同，用于做rolling upgrade</li>
<li>primary删除了100条: db.foo.remove({age:30})  -> secondary: 100条命令 db.foo.remove({_id: }) ……<br>* </li>
</ul>
<h2 id="replicat-sets"><a href="#replicat-sets" class="headerlink" title="replicat sets"></a>replicat sets</h2><ul>
<li>自动failover （大概10s，6个9），应用（客户端）会自动连接到新的primary</li>
<li>自动recover，如果P节点down掉，选举产生新的P节点；老的P节点up之后，会自动rollback（回滚在该节点commit但是还没来得及sync到其他节点的操作），然后加入新的集群</li>
<li>复制集最多可以有50个成员，7个投票节点（建议每个复制集的arbiter不要超过1个）</li>
<li>hidden：priority 0，不可能成为primary，可以vote，只有数据复制的流量（没有读流量），用于报表和备份，db.isMaster()看不到</li>
<li>delay节点最好是hidden，priority 0, vote 1,备份的时候使用db.fsynclock()</li>
<li>non-vote节点，保证投票节点不超过7个，同时能分担读压力；priority 0， vote 0</li>
</ul>
<h2 id="create-replicate-set"><a href="#create-replicate-set" class="headerlink" title="create replicate set"></a>create replicate set</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mongod --port 27001 -replSet cluster --dbpath /data/1 --logpath /data/1/1.log --logappend --oplogSize 50 --smallfiles --fork</span><br><span class="line">mongod --port 27002 -replSet cluster --dbpath /data/2 --logpath /data/2/2.log --logappend --oplogSize 50 --smallfiles --fork</span><br><span class="line">mongod --port 27003 -replSet cluster --dbpath /data/3 --logpath /data/3/3.log --logappend --oplogSize 50 --smallfiles --fork</span><br><span class="line"></span><br><span class="line">mongo --port 27001</span><br><span class="line">&gt;  cfg = &#123;</span><br><span class="line">... _id : &quot;cluster&quot;,</span><br><span class="line">... members : [</span><br><span class="line">...  &#123; _id:0, host:&quot;mongotest:27001&quot; &#125;,</span><br><span class="line">...  &#123; _id:1, host:&quot;mongotest:27002&quot; &#125;,</span><br><span class="line">...  &#123; _id:2, host:&quot;mongotest:27003&quot; &#125;</span><br><span class="line">... ]</span><br><span class="line">... &#125;</span><br><span class="line"></span><br><span class="line">&gt; rs.initiate(cfg)</span><br><span class="line"></span><br><span class="line">帮助命令 rs.help()</span><br></pre></td></tr></table></figure>
<h3 id="使从节点能读"><a href="#使从节点能读" class="headerlink" title="使从节点能读"></a>使从节点能读</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cluster:SECONDARY&gt; rs.slaveOk(）</span><br><span class="line"></span><br><span class="line">for ( var i =0 ; i &lt; 50000 ; i++) &#123;db.foo.insert(&#123;_id : i&#125;); sleep(1);&#125;</span><br></pre></td></tr></table></figure>
<h3 id="replication-options"><a href="#replication-options" class="headerlink" title="replication options"></a>replication options</h3><ul>
<li>arbiterOnly: true   投票节点，没有数据</li>
<li>priority: <n>  0永远不会成为primary，不能是负数，可以有小数点</n></li>
<li>hidden: <bool> 隐藏节点，client不会看到，不会成为primary</bool></li>
<li>salveDelay: <seconds> 延迟节点，对于误操作快速恢复数据，不能用于fullbackup，priority=0 hidden=true</seconds></li>
<li>votes: <n></n></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">&gt; var cfg =rs.conf()</span><br><span class="line">&gt; &gt; cfg</span><br><span class="line">&#123;</span><br><span class="line">        &quot;_id&quot; : &quot;cluster&quot;,</span><br><span class="line">        &quot;version&quot; : 1,</span><br><span class="line">        &quot;protocolVersion&quot; : NumberLong(1),</span><br><span class="line">        &quot;members&quot; : [</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;_id&quot; : 0,</span><br><span class="line">                        &quot;host&quot; : &quot;mongotest:27001&quot;,</span><br><span class="line">                        &quot;arbiterOnly&quot; : false,</span><br><span class="line">                        &quot;buildIndexes&quot; : true,</span><br><span class="line">                        &quot;hidden&quot; : false,</span><br><span class="line">                        &quot;priority&quot; : 1,</span><br><span class="line">                        &quot;tags&quot; : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        &quot;slaveDelay&quot; : NumberLong(0),</span><br><span class="line">                        &quot;votes&quot; : 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;_id&quot; : 1,</span><br><span class="line">                        &quot;host&quot; : &quot;mongotest:27002&quot;,</span><br><span class="line">                        &quot;arbiterOnly&quot; : false,</span><br><span class="line">                        &quot;buildIndexes&quot; : true,</span><br><span class="line">                        &quot;hidden&quot; : false,</span><br><span class="line">                        &quot;priority&quot; : 1,</span><br><span class="line">                        &quot;tags&quot; : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        &quot;slaveDelay&quot; : NumberLong(0),</span><br><span class="line">                        &quot;votes&quot; : 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;_id&quot; : 2,</span><br><span class="line">                        &quot;host&quot; : &quot;mongotest:27003&quot;,</span><br><span class="line">                        &quot;arbiterOnly&quot; : false,</span><br><span class="line">                        &quot;buildIndexes&quot; : true,</span><br><span class="line">                        &quot;hidden&quot; : false,</span><br><span class="line">                        &quot;priority&quot; : 1,</span><br><span class="line">                        &quot;tags&quot; : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        &quot;slaveDelay&quot; : NumberLong(0),</span><br><span class="line">                        &quot;votes&quot; : 1</span><br><span class="line">                &#125;</span><br><span class="line">        ],</span><br><span class="line">        &quot;settings&quot; : &#123;</span><br><span class="line">                &quot;chainingAllowed&quot; : true,</span><br><span class="line">                &quot;heartbeatIntervalMillis&quot; : 2000,</span><br><span class="line">                &quot;heartbeatTimeoutSecs&quot; : 10,</span><br><span class="line">                &quot;electionTimeoutMillis&quot; : 10000,</span><br><span class="line">                &quot;catchUpTimeoutMillis&quot; : 60000,</span><br><span class="line">                &quot;getLastErrorModes&quot; : &#123;</span><br><span class="line"></span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;getLastErrorDefaults&quot; : &#123;</span><br><span class="line">                        &quot;w&quot; : 1,</span><br><span class="line">                        &quot;wtimeout&quot; : 0</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;replicaSetId&quot; : ObjectId(&quot;59c1d4b929c0b87e17d81e45&quot;)</span><br><span class="line">        &#125;</span><br><span class="line">&gt; cfg.members[2].slaveDelay = 120</span><br><span class="line">&gt; rs.reconfig(cfg)</span><br></pre></td></tr></table></figure>
<ul>
<li>3members（2data+1arbiter）,可以failover，但是writeconcern=majority不重要</li>
<li>2members 手工failover</li>
</ul>
<h3 id="init-sync"><a href="#init-sync" class="headerlink" title="init sync"></a>init sync</h3><ol>
<li>克隆除了local以外的所有数据库</li>
<li>3.4在克隆的时候会创建索引，3.4之前只会创建_id索引</li>
<li>克隆期间的oplog会复制到从节点并应用</li>
<li>init sync期间rename collection会重传</li>
</ol>
<h3 id="选举election"><a href="#选举election" class="headerlink" title="选举election"></a>选举election</h3><ol>
<li>选举期间，没有primary可写，其余的节点为read-only</li>
<li>和选举有关的因素：protocol （verison 1）、heartbeat（2秒一次，10秒没有响应被标记为、inaccessible）、priority（高优先级的节点更早发起选举，更有可能会赢得选举，成为primary；低优先级的如果数据更新会赢得选举）、Loss of a Data Center、network partition</li>
</ol>
<h3 id="rollback"><a href="#rollback" class="headerlink" title="rollback"></a>rollback</h3><ol>
<li>rollback的数据在目录dbpath下，database.collection.timestamp.bson，使用bsondump查看</li>
<li>默认write concern{w ： 1}，设为{w : majority}可以防止回滚</li>
<li>超过300M的数据不会被回滚</li>
</ol>
<h3 id="rs-status"><a href="#rs-status" class="headerlink" title="rs.status()"></a>rs.status()</h3><ol>
<li>rs.status()和db.adminCommand( { replSetGetStatus : 1 } )一样</li>
</ol>
<h3 id="oplog"><a href="#oplog" class="headerlink" title="oplog"></a>oplog</h3><ol>
<li>在primary操作后再写入oplog</li>
<li>保存在集合local.oplog.rs</li>
<li>oplog中的操作为幂等性，执行多次和一次结果一样</li>
<li>oplog size，unix（5%的free disk space、最大50G），通过参数oplogSizeMB指定大小</li>
</ol>
<h3 id="read-preference"><a href="#read-preference" class="headerlink" title="read preference"></a>read preference</h3><ol>
<li>默认从priamry读，nearest 从网络延迟最小的节点读取</li>
</ol>
<h3 id="write-concern"><a href="#write-concern" class="headerlink" title="write concern"></a>write concern</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">w: &lt;value&gt;, j: &lt;boolean&gt;, wtimeout: &lt;number&gt; &#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>w:默认1</li>
<li>如果mongodb的journal是enable的，w : “majority”隐含j: true</li>
<li>wtimeout:如果不设置，w：无法完成的时候，会一直block下去</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Dbits</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">13</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Dbits</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  

    
      <script id="dsq-count-scr" src="https://http-chnsin365-github-io.disqus.com/count.js" async></script>
    

    

  




	





  














  





  

  

  

  
  

  

  

  

</body>
</html>
