<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Feng">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Feng">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Feng">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>Feng</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Feng</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/03/MongoDB-3-4-Storage-Engine/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Feng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Feng">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/03/MongoDB-3-4-Storage-Engine/" itemprop="url">MongoDB 3.4 - Storage Engine</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-03T10:19:19+08:00">
                2018-01-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MongoDB/" itemprop="url" rel="index">
                    <span itemprop="name">MongoDB</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/01/03/MongoDB-3-4-Storage-Engine/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/01/03/MongoDB-3-4-Storage-Engine/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="WT-Engine"><a href="#WT-Engine" class="headerlink" title="WT Engine"></a>WT Engine</h2><ol>
<li>3.0开始，WT在64bit的MongoDB上可用</li>
<li>3.2开始，WT作为MongoDB的默认存储引擎</li>
<li>WT提供压缩功能，支持文档级别的锁</li>
</ol>
<h3 id="Snapshot-amp-Checkpoint"><a href="#Snapshot-amp-Checkpoint" class="headerlink" title="Snapshot &amp; Checkpoint"></a>Snapshot &amp; Checkpoint</h3><ol>
<li>60s或者journal log &gt; 2G,触发checkpoint，将data files的一致性数据写入磁盘</li>
<li>在将snapshot刷新入disk时，前一个checkpint还是valid状态</li>
<li>如果在此时发生错误，可以从前一个checkpoint恢复</li>
<li>如果写入后发生错误，可以从最近一个checkpoint恢复，再使用journal log将checkpoint后的数据recover</li>
</ol>
<h3 id="Journal"><a href="#Journal" class="headerlink" title="Journal"></a>Journal</h3><ol>
<li>journal是write-ahead transaction log</li>
<li>记录两次checkpoint之间的数据，保证能够在数据库发生错误后使用snapshot和journal将数据库恢复到故障前的状态</li>
<li>WT默认使用snappy机制压缩journal log</li>
<li>默认的buffer大小128kB，</li>
<li>&lt;128byte的log record,不压缩</li>
<li>journal file在MMAPv1要和datafile放在一个路径下面，</li>
</ol>
<h3 id="journal-sync条件"><a href="#journal-sync条件" class="headerlink" title="journal sync条件"></a>journal sync条件</h3><ul>
<li>50ms （3.2 WT） 100ms（MMAPV1）</li>
<li>j:true会触发</li>
<li>checkpoint （60s或者&gt;2G）</li>
<li>journal file切换 (每个journal file是100MB）</li>
</ul>
<h3 id="Compression"><a href="#Compression" class="headerlink" title="Compression"></a>Compression</h3><ol>
<li>WT支持对collection和index的压缩，消耗更多CPU</li>
<li>默认使用snappy压缩算法，block级别的压缩</li>
<li>可以对单个collection或者index设置压缩</li>
</ol>
<h3 id="内存的使用"><a href="#内存的使用" class="headerlink" title="内存的使用"></a>内存的使用</h3><ol>
<li>MongoDB使用WT internal cache和file system cache</li>
<li>WT默认大小：物理内存 * 50% - 1GB 或者 256MB</li>
<li>filesystem cache用于降低disk I/O，数据在file system cache里的格式和disk上是一样的</li>
<li>索引在WT cache里的格式和disk上的是不一样的，但是一样可以使用prefix index压缩降低内存使用量</li>
<li>collection的数据在WT cache里是没有压缩的，数据在WT内的操作要先解压</li>
<li>除WT cache和其他系统使用掉的内存，MongoDB会使用剩余的所有内存作为file system cache</li>
</ol>
<h2 id="MMAPV1"><a href="#MMAPV1" class="headerlink" title="MMAPV1"></a>MMAPV1</h2><h3 id="Power-of-2-Sized-Allocations"><a href="#Power-of-2-Sized-Allocations" class="headerlink" title="Power of 2 Sized Allocations"></a>Power of 2 Sized Allocations</h3><ol>
<li>如果更新后文档不能在预先分配的空间内存下，则需要move到其他地方，同时更新索引，引起性能开销，并且带来碎片化</li>
<li>3.0 每个文档的尺寸大小为2的整数倍</li>
<li>对于insert only的数据，记录大小不会增长，可以关闭power of 2，使用collMod命令，参数noPadding</li>
<li>MMAPv1使用系统所有的剩余内存，内存使用是动态的，如果有其他的进程需要使用系统内存，MongoDB会让出一部分内存</li>
</ol>
<h3 id="Memory-use"><a href="#Memory-use" class="headerlink" title="Memory use"></a>Memory use</h3><ol>
<li>mem.resident 目前正在使用的内存大小</li>
<li>mem.mapped mongod使用的map的内存大小，如果比实际内存要大很多，可能会发生page fault</li>
</ol>
<h3 id="page-fault"><a href="#page-fault" class="headerlink" title="page fault"></a>page fault</h3><ol>
<li>当读取的数据，或者写入的数据文件没有map到内存上，会发生page fault</li>
<li>extra_info.page_faults</li>
</ol>
<h3 id="Summary-of-Major-Differences-between-MMAPv1-and-WiredTiger"><a href="#Summary-of-Major-Differences-between-MMAPv1-and-WiredTiger" class="headerlink" title="Summary of Major Differences between MMAPv1 and WiredTiger"></a>Summary of Major Differences between MMAPv1 and WiredTiger</h3><h4 id="Locks-Concurrency"><a href="#Locks-Concurrency" class="headerlink" title="Locks/Concurrency"></a>Locks/Concurrency</h4><ul>
<li>MMAPv1 uses collection level locking in MongoDB 3.0</li>
<li>WiredTiger supports document-level concurrency</li>
</ul>
<h4 id="Journaling"><a href="#Journaling" class="headerlink" title="Journaling"></a>Journaling</h4><ul>
<li>Journaling is recommended for both MMAPv1 and WiredTiger</li>
<li>For MMAPv1, it ensures that writes are atomic</li>
<li>For WT, it ensures that writes make it to disk between checkpoints</li>
</ul>
<h4 id="Data-Compression"><a href="#Data-Compression" class="headerlink" title="Data Compression"></a>Data Compression</h4><ul>
<li>WiredTiger supports both the snappy and zlib compression algorithms</li>
<li>MMAPv1 does not support data compression</li>
</ul>
<h4 id="Other-Considerations"><a href="#Other-Considerations" class="headerlink" title="Other Considerations"></a>Other Considerations</h4><ul>
<li>Due to the way MMAPv1 organizes data, if a BSON document outgrows its allotted space, it must be moved. Indexes that point to this document point to its file offset and will need to be updated. As a consequence, writes that force a document to move on disk come at a relatively high performance cost. Document movement also leads to fragmentation.</li>
<li>To minimize document movement, MMAPv1 uses a power-of-two size allocation strategy, allocating a “record space” to each document that is larger than the document. If the document outgrows its record space, the newly allocated space for the document will be twice as large as the previous allocation. Power-of-two sizing also enables the storage engine to more easily reuse space vacated by a moved document, because all document allocations will be a size that is a power of two.</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/03/MongoDB-3-4-Diagnostics-and-Debugging/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Feng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Feng">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/03/MongoDB-3-4-Diagnostics-and-Debugging/" itemprop="url">MongoDB 3.4 - Diagnostics and Debugging</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-03T10:17:46+08:00">
                2018-01-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MongoDB/" itemprop="url" rel="index">
                    <span itemprop="name">MongoDB</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/01/03/MongoDB-3-4-Diagnostics-and-Debugging/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/01/03/MongoDB-3-4-Diagnostics-and-Debugging/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="server-log"><a href="#server-log" class="headerlink" title="server log"></a>server log</h2><ol>
<li>遇到问题先看log</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;timestamp&gt; &lt;severity&gt; &lt;component&gt; [&lt;context&gt;] &lt;message&gt;</span><br></pre></td></tr></table></figure>
<h3 id="修改log的级别"><a href="#修改log的级别" class="headerlink" title="修改log的级别"></a>修改log的级别</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.getLogComponents()</span><br><span class="line">db.setLogLevel(-1, &quot;query&quot;)</span><br></pre></td></tr></table></figure>
<h3 id="logrotate"><a href="#logrotate" class="headerlink" title="logrotate"></a>logrotate</h3><p>–logRotate默认参数是rename，会在原来的日志文件后面加上一个时间戳，如果使用参数reopen，则必须指定参数–logappend<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.adminCommand( &#123; logRotate : 1 &#125; )</span><br></pre></td></tr></table></figure></p>
<h2 id="db-serverStatus"><a href="#db-serverStatus" class="headerlink" title="db.serverStatus()"></a>db.serverStatus()</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">&gt; Object.keys(db.serverStatus())</span><br><span class="line">[</span><br><span class="line">        &quot;host&quot;,</span><br><span class="line">        &quot;version&quot;,</span><br><span class="line">        &quot;process&quot;,</span><br><span class="line">        &quot;pid&quot;,</span><br><span class="line">        &quot;uptime&quot;,</span><br><span class="line">        &quot;uptimeMillis&quot;,</span><br><span class="line">        &quot;uptimeEstimate&quot;,</span><br><span class="line">        &quot;localTime&quot;,</span><br><span class="line">        &quot;asserts&quot;,</span><br><span class="line">        &quot;connections&quot;,</span><br><span class="line">        &quot;extra_info&quot;,</span><br><span class="line">        &quot;globalLock&quot;,</span><br><span class="line">        &quot;locks&quot;,</span><br><span class="line">        &quot;network&quot;,</span><br><span class="line">        &quot;opLatencies&quot;,</span><br><span class="line">        &quot;opcounters&quot;,</span><br><span class="line">        &quot;opcountersRepl&quot;,</span><br><span class="line">        &quot;storageEngine&quot;,</span><br><span class="line">        &quot;tcmalloc&quot;,</span><br><span class="line">        &quot;wiredTiger&quot;,</span><br><span class="line">        &quot;mem&quot;,</span><br><span class="line">        &quot;metrics&quot;,</span><br><span class="line">        &quot;ok&quot;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># for loop that iterates over few documents with a sleep</span><br><span class="line">mongo --eval &apos; while(true) &#123; for (i=1; i&lt;=10; i++)&#123;</span><br><span class="line">  db.things.insertOne(&#123;&#125;); sleep(1000);</span><br><span class="line">&#125;&#125; &apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; db.serverStatus().localTime</span><br><span class="line">ISODate(&quot;2017-10-26T07:55:44.169Z&quot;)</span><br><span class="line"></span><br><span class="line">&gt; db.serverStatus().locks</span><br><span class="line">&#123;</span><br><span class="line">        &quot;Global&quot; : &#123;</span><br><span class="line">                &quot;acquireCount&quot; : &#123;</span><br><span class="line">                        &quot;r&quot; : NumberLong(2340),</span><br><span class="line">                        &quot;w&quot; : NumberLong(7),</span><br><span class="line">                        &quot;W&quot; : NumberLong(3)</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Database&quot; : &#123;</span><br><span class="line">                &quot;acquireCount&quot; : &#123;</span><br><span class="line">                        &quot;r&quot; : NumberLong(767),</span><br><span class="line">                        &quot;R&quot; : NumberLong(11),</span><br><span class="line">                        &quot;W&quot; : NumberLong(7)</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Collection&quot; : &#123;</span><br><span class="line">                &quot;acquireCount&quot; : &#123;</span><br><span class="line">                        &quot;r&quot; : NumberLong(767)</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Metadata&quot; : &#123;</span><br><span class="line">                &quot;acquireCount&quot; : &#123;</span><br><span class="line">                        &quot;w&quot; : NumberLong(1)</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>R:shared lock; W: exclusive lock; r: intent shared lock; w: intent exclusive lock</p>
<p>opcounters只记录操作数，不包含受影响的document统计；metrics.document包含操作影响到的document</p>
<p>db.serverStatus().globalLock.totalTime如果和uptime接近，表示数据库一直有锁的性能问题</p>
<p>db.serverStatus().globalLock.currentQueue.total 表示实时的锁统计信息  </p>
</blockquote>
<h2 id="profiler"><a href="#profiler" class="headerlink" title="profiler"></a>profiler</h2><ul>
<li>针对数据库级别的，非整个mongod server</li>
<li>{0:off,1:slow,2:whole}</li>
<li>db.system.profile 是一个capped集合，默认大小1m</li>
<li>默认slow operation阀值100ms</li>
<li>不能在mongos打开profiler，需要在cluster内的每个mongod上操作</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;db.setProfilingLevel(2)</span><br><span class="line">&gt;db.system.profile.find().pretty()</span><br><span class="line">&gt;db.system.profile.find().sort(&#123;$natural: -1&#125;).limit(1).pretty()</span><br><span class="line">&gt;db.getProfilingStatus()</span><br><span class="line">&gt;db.system.profile.aggregate( [ &#123; $group : &#123;_id : &quot;$op&quot;, count : &#123; $sum : 1&#125;&#125;&#125;])</span><br></pre></td></tr></table></figure>
<h2 id="indexStats"><a href="#indexStats" class="headerlink" title="indexStats"></a>indexStats</h2><ol>
<li>可以使用$indeStats查看哪些索引没有被使用</li>
<li>复制集内的各节点单独计数</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.people.aggregate( [ &#123; $indexStats : &#123; &#125; &#125; ] ).pretty()</span><br><span class="line"></span><br><span class="line">db.people.aggregate( [</span><br><span class="line">  &#123; $indexStats : &#123; &#125; &#125;,</span><br><span class="line">  &#123; $project : &#123; key: 1, &quot;accesses.ops&quot;: 1 &#125; &#125;</span><br><span class="line">] ).pretty()</span><br></pre></td></tr></table></figure>
<h2 id="慢查询"><a href="#慢查询" class="headerlink" title="慢查询"></a>慢查询</h2><h3 id="导致的因素"><a href="#导致的因素" class="headerlink" title="导致的因素:"></a>导致的因素:</h3><ol>
<li>working set大小超过内存</li>
</ol>
<h2 id="mtools"><a href="#mtools" class="headerlink" title="mtools"></a>mtools</h2><h3 id="mloginfo"><a href="#mloginfo" class="headerlink" title="mloginfo"></a>mloginfo</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">mloginfo --queries --no-progressbar mongodb.log</span><br><span class="line">     source: mongodb.log</span><br><span class="line">       host: dc1custdb06:27000</span><br><span class="line">      start: 2017 Oct 25 20:04:16.308</span><br><span class="line">        end: 2017 Oct 26 10:41:55.182</span><br><span class="line">date format: iso8601-local</span><br><span class="line">     length: 237443</span><br><span class="line">     binary: mongod</span><br><span class="line">    version: 3.4.6</span><br><span class="line">    storage: wiredTiger</span><br><span class="line"></span><br><span class="line">QUERIES</span><br><span class="line">namespace                          operation    pattern                                 count    min (ms)    max (ms)    mean (ms)    95%-ile (ms)    sum (ms)</span><br><span class="line"></span><br><span class="line">mucem.metricData                   find         &#123;&quot;dataType&quot;: 1, &quot;metricData&quot;: 1&#125;        64956         100     1314642         2826          2273.0    183600980</span><br><span class="line">mucem.individual                   find         &#123;&quot;indivCerts.certNum&quot;: 1&#125;                4883         100       93637         1773          9577.9    8662154</span><br><span class="line">mucem.mumobileAccount              find         &#123;&quot;lstUpdTime&quot;: 1, &quot;prcSts&quot;: 1&#125;            685         120     1548426         5301          2878.2    3631317</span><br><span class="line">mucem.muAppUserInfo                find         &#123;&quot;_id&quot;: 1&#125;                                438         110       52225         5786        17874.15    2534591</span><br><span class="line">mucem.individual                   find         &#123;&quot;memberships.memshpCardNo&quot;: 1&#125;          1165         100       94250         2051          9986.2    2389683</span><br><span class="line">local.clustermanager               find         None                                      435         100       52231         4706         16964.0    2047117</span><br><span class="line">mucem.mumobileAccount              find         &#123;&quot;_id&quot;: 1&#125;                                269         100       83832         7591         28043.0    2042084</span><br><span class="line">mucem.muAppUserInfo                find         &#123;&quot;lstUpdTime&quot;: 1, &quot;prcSts&quot;: 1&#125;            122         100      278448        16023        69047.45    1954891</span><br><span class="line">mucem.paxEvt                       find         &#123;&quot;lstUpdTime&quot;: 1, &quot;paxEvtPrcSts&quot;: 1&#125;      180         101     1198138        10065         1916.25    1811708</span><br><span class="line">mucem.abnorFltEvt                  find         &#123;&quot;abnorFltEvtPrcSts&quot;: 1&#125;                   82         102      208458        17830         88588.7    1462116</span><br><span class="line">mucem.mumobileAccount              find         &#123;&quot;crtTime&quot;: &#123;&quot;$ne&quot;: 1&#125;&#125;                   125         242      708768        11449         10282.2    1431224</span><br><span class="line">mucemcustprofilepsdp.individual    count        &#123;&quot;mobiles.numBody&quot;: 1&#125;                    456         100      248685         3001        12686.75    1368538</span><br><span class="line">mucemcustprofilepsdp.metricData    find         &#123;&quot;dataType&quot;: 1, &quot;metricData&quot;: 1&#125;          283         100       56042         3085         17011.3    873298</span><br><span class="line">local.system.replset               find         None                                      100         102       34156         6839        18707.45    683970</span><br><span class="line">mucem.individual                   update       &#123;&quot;_id&quot;: 1&#125;                               2021         100        5554          138           198.0    280099</span><br><span class="line">mucem.individual                   count        &#123;&quot;mobiles.numBody&quot;: 1&#125;                    188         100       39015         1468         6539.15    276109</span><br><span class="line">admin.system.users                 find         &#123;&#125;                                         43         103       22636         4455         13284.6    191586</span><br><span class="line">local.oplog.rs                     getmore      None                                        1       60444       60444        60444         60444.0    60444</span><br><span class="line">mucem.labelLibraryData             update       &#123;&quot;_id&quot;: 1&#125;                                 89         101        5565          629          5500.0    56042</span><br><span class="line">mucem.custDtl                      update       &#123;&quot;_id&quot;: 1&#125;                                 80         100        5541          690          5529.1    55249</span><br><span class="line">mucem.custMonth                    find         &#123;&quot;indvlCardNbr&quot;: 1&#125;                       147         100        5555          156           175.7    23071</span><br><span class="line">mucem.custDtl                      find         &#123;&quot;lstUpdTime&quot;: 1, &quot;status&quot;: 1&#125;             85         100        5552          256           196.6    21809</span><br><span class="line">mucem.custDest                     find         &#123;&quot;indvlCardNbr&quot;: 1&#125;                       114         100        5554          171           186.8    19567</span><br><span class="line">mucem.muAppUserInfo                find         None                                        8         118       13605         2196          9923.0    17571</span><br><span class="line">mucem.paxEvt                       update       &#123;&quot;_id&quot;: 1&#125;                                 68         101        5533          255          486.95    17358</span><br><span class="line">mucem.custOrig                     find         &#123;&quot;indvlCardNbr&quot;: 1&#125;                       132         100         263          118           188.5    15700</span><br><span class="line">mucem.individual                   update       &#123;&quot;custId&quot;: 1&#125;                              38         100        5573          408         1050.85    15534</span><br><span class="line">mucem.custLine                     find         &#123;&quot;indvlCardNbr&quot;: 1&#125;                       122         100         218          120           182.9    14710</span><br><span class="line">mucem.labelLibraryData             find         &#123;&quot;lstUpdTime&quot;: 1, &quot;status&quot;: 1&#125;             24         102        5549          597          4749.4    14335</span><br><span class="line">mucem.custAircraft                 find         &#123;&quot;indvlCardNbr&quot;: 1&#125;                       111         100         231          127           222.0    14128</span><br><span class="line">mucem.muAppUserInfo                update       &#123;&quot;_id&quot;: 1&#125;                                 69         100        4006          179           178.2    12381</span><br><span class="line">mucem.individual                   find         &#123;&quot;mobiles.numBody&quot;: 1&#125;                     28         105        1845          425          1538.2    11923</span><br><span class="line">mucem.mumobileAccount              update       &#123;&quot;_id&quot;: 1&#125;                                 18         105         511          300           483.8    5414</span><br><span class="line">mucemcustprofilepsdp.metricData    update       &#123;&quot;_id&quot;: 1&#125;                                  3         106         225          150           214.6    452</span><br><span class="line">local.oplog.rs                     find         &#123;&quot;ts&quot;: 1&#125;                                   1         162         162          162           162.0    162</span><br><span class="line">mucem.metricData                   update       &#123;&quot;_id&quot;: 1&#125;                                  1         107         107          107           107.0    107</span><br></pre></td></tr></table></figure>
<h3 id="mplotqueries"><a href="#mplotqueries" class="headerlink" title="mplotqueries"></a>mplotqueries</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mplotqueries mongodb.log</span><br></pre></td></tr></table></figure>
<h3 id="mlogvis"><a href="#mlogvis" class="headerlink" title="mlogvis"></a>mlogvis</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mlogvis --no-browser mongodb.log</span><br></pre></td></tr></table></figure>
<h2 id="timeout"><a href="#timeout" class="headerlink" title="timeout"></a>timeout</h2><ol>
<li>serverSelectionTimeoutError: 发生在client端，当没有可用的server时候</li>
<li>WTimeoutError： db.foo.insertOne({hello : ‘world’}, {writeConcern : {w : 3, wtimeout : 2}) 如果2ms内没有完成，写入还是会做，但是会报错。</li>
<li>ExecutionTimeout: cursor parameter,如果在规定时间内没有执行完成，返回错误; db.collection.find({})._addSpecial(“$maxTimes”, 100)</li>
<li>networkTimeout： 和网络配置相关</li>
</ol>
<h2 id="closing-and-dropping-connections"><a href="#closing-and-dropping-connections" class="headerlink" title="closing and dropping connections"></a>closing and dropping connections</h2><ol>
<li>连接比较占用虚拟内存 mongostat里面的vsize，每个连接占用1M内存</li>
<li>default max incoming connection 65536</li>
<li>配置文件里可以使用maxIncomingConnections设置</li>
<li>ulimit -a里面的openfile会对连接数有影响；connection、index、collection都是一个文件</li>
<li>db.serverStatus().connection的数量和ulimit -a有关系</li>
</ol>
<h2 id="write-concern-w-majority"><a href="#write-concern-w-majority" class="headerlink" title="write concern(w: majority)"></a>write concern(w: majority)</h2><ol>
<li>3节点，如果有一个投票节点，data secondary节点发生故障的时候则写入会报错WriteConcernFailed，但是数据还是会写入</li>
<li>3节点，如果有一个延迟节点，uptodate节点发生故障的时候则写入会报错WriteConcernFailed，但是数据还是会写入</li>
<li>不要依赖于arbiter和delay节点作为write concern</li>
</ol>
<h2 id="schema-issue"><a href="#schema-issue" class="headerlink" title="schema issue"></a>schema issue</h2><ol>
<li>找出是否有集合扫描</li>
</ol>
<pre><code>db.setProfilingLevel(2)
db.setProfilingLevel(0)
db.system.profile.count()
db.system.profile.find({}, {planSummary: 1})
db.system.profile.find({}, {planSummary: 1, op: 1, query: 1, ns: 1}).pretty()
db.system.profile.aggregate([ {$group : { _id : {op : &quot;$op&quot;, ns : &quot;$ns&quot;}}} ])
</code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/03/MongoDB-3-4-Backup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Feng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Feng">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/03/MongoDB-3-4-Backup/" itemprop="url">MongoDB 3.4 - Backup</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-03T10:15:45+08:00">
                2018-01-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MongoDB/" itemprop="url" rel="index">
                    <span itemprop="name">MongoDB</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/01/03/MongoDB-3-4-Backup/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/01/03/MongoDB-3-4-Backup/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="备份单个server或者replicatset的方法"><a href="#备份单个server或者replicatset的方法" class="headerlink" title="备份单个server或者replicatset的方法"></a>备份单个server或者replicatset的方法</h2><ol>
<li>mongodump</li>
<li>filesystem snapshot</li>
<li>backup from secondary (shutdown - copy file - startup)</li>
</ol>
<h3 id="mongodump"><a href="#mongodump" class="headerlink" title="mongodump"></a>mongodump</h3><ol>
<li>备份全部或者单个database（不会备份local database），–oplog</li>
<li>用mongorestore恢复，–oplogreplay,需要有resotre的role，如果被恢复的备份含有system.profile,但是目标数据库上没有，会创建system.profile，但是不会恢复数据</li>
<li>产生的是BSON文件，对于小的数据库比较适用</li>
<li>mongodump只备份document，但是mongorestore在恢复完数据后会rebuild索引</li>
<li>mongodump会影响数据库性能，如果数据库很大，可能会消耗光内存产生page fault</li>
</ol>
<h3 id="文件系统快照"><a href="#文件系统快照" class="headerlink" title="文件系统快照"></a>文件系统快照</h3><ol>
<li>使用lvm或者存储的快照机制</li>
<li>开启journal</li>
<li>db.fsyncLock()–把数据flush到磁盘，禁止写入新的数据 – snapshot – db.fsyncUnlock(); 这个期间可能无法对数据库进行查询</li>
</ol>
<blockquote>
<p>注意：在使用db.fsyncLock()期间，不要断开session，否则可能会无法重新连接到数据库</p>
</blockquote>
<h3 id="备份sharded-cluster"><a href="#备份sharded-cluster" class="headerlink" title="备份sharded cluster"></a>备份sharded cluster</h3><ol>
<li>关闭balancer  sh.stopBalancer(),如果在进行chunk migration，需要等待结束</li>
<li>备份config database  mongodump –db config</li>
<li>备份每一个分片</li>
<li>开启balancer </li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># back up a shard cluster</span><br><span class="line"></span><br><span class="line">mongo --host 	some_mongos --eval &quot;sh.stopBalancer()&quot;</span><br><span class="line"># make sure that worked!</span><br><span class="line"></span><br><span class="line"># back up config database / a config server</span><br><span class="line">mongdump --host some_mongos_or_config_server --db config</span><br><span class="line"></span><br><span class="line"># back up all shards</span><br><span class="line">mongodump --host shard1_svr1 --oplog /backups/cluster1/shard1</span><br><span class="line">mongodump --host shard2_svr1 --oplog /backups/cluster1/shard2</span><br><span class="line">mongodump --host shard3_svr1 --oplog /backups/cluster1/shard3</span><br><span class="line">mongodump --host shard4_svr1 --oplog /backups/cluster1/shard4</span><br><span class="line">mongodump --host shard5_svr1 --oplog /backups/cluster1/shard5</span><br><span class="line">mongodump --host shard6_svr1 --oplog /backups/cluster1/shard6</span><br><span class="line"></span><br><span class="line"># balancer back on</span><br><span class="line">mongo --host some_mongos --eval &quot;sh.startBalancer()&quot;</span><br></pre></td></tr></table></figure>
<h2 id="一些特性"><a href="#一些特性" class="headerlink" title="一些特性"></a>一些特性</h2><h3 id="capped-collections"><a href="#capped-collections" class="headerlink" title="capped collections"></a>capped collections</h3><ol>
<li>circle queue</li>
<li>least-recently-insert order</li>
<li>preallocated max size</li>
<li>can’t delete or grow</li>
</ol>
<h3 id="TTL-Collections"><a href="#TTL-Collections" class="headerlink" title="TTL Collections"></a>TTL Collections</h3><ol>
<li>auto ageout of documents</li>
<li>create special index</li>
</ol>
<h3 id="Grid-FS"><a href="#Grid-FS" class="headerlink" title="Grid FS"></a>Grid FS</h3><ol>
<li>BSON file size limited 16MB<br>`</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/03/MongoDB-3-4-Scalability/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Feng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Feng">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/03/MongoDB-3-4-Scalability/" itemprop="url">MongoDB 3.4 - Scalability</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-03T10:15:00+08:00">
                2018-01-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MongoDB/" itemprop="url" rel="index">
                    <span itemprop="name">MongoDB</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/01/03/MongoDB-3-4-Scalability/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/01/03/MongoDB-3-4-Scalability/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="sharding-amp-data-distribute"><a href="#sharding-amp-data-distribute" class="headerlink" title="sharding &amp; data distribute"></a>sharding &amp; data distribute</h3><p>分片的好处：</p>
<ol>
<li>查询（落在分片上，可以直接读取对应的分片）</li>
<li>排序</li>
</ol>
<h3 id="chunks"><a href="#chunks" class="headerlink" title="chunks"></a>chunks</h3><ul>
<li>chunks的默认大小64M</li>
<li>step1 split chunk的大小超过限制后，分裂为2个chunk，但是还在原来的分片上； step2 migrate 均衡chunks在分片上的数量</li>
<li>chunk size 小，migrate多，数据在分片上分布更均匀，但是对config server的开销越大； chunk size 大，migrate少，数据在分片上分布可能不太均衡</li>
<li>连续的chunks不保证在一个shard上</li>
<li>修改chunk size (1-1024M)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">connect to mongos</span><br><span class="line">use config</span><br><span class="line">db.settings.save( &#123; _id:&quot;chunksize&quot;, value: &lt;sizeInMB&gt; &#125; )</span><br></pre></td></tr></table></figure>
<h3 id="chunk-migration"><a href="#chunk-migration" class="headerlink" title="chunk migration"></a>chunk migration</h3><ol>
<li>手工：在bulk write之前手动migration</li>
<li>自动：blancer进程在触发阀值后执行migration（\<20 2;="" 20-79="" 4;="" \="">80 8）</20></li>
<li>sh.isBalancerRunning(）</li>
<li>balance进程运行在primary config server上，3.4之前只能有一个migration进程，3.4开始，可以有n/2个（n代表shards的数量）</li>
</ol>
<h3 id="Config-Server"><a href="#Config-Server" class="headerlink" title="Config Server"></a>Config Server</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use config</span><br><span class="line">show collections</span><br></pre></td></tr></table></figure>
<p>可以将mongos的端口指定为27017<br>admin数据库含有集群用户认证信息<br>config数据库包含集群的metadata信息</p>
<h3 id="mongos"><a href="#mongos" class="headerlink" title="mongos"></a>mongos</h3><ol>
<li>sort操作在primary shard上进行，3.2开始，aggr操作可以在任意的shard上进行</li>
<li>db.isMaster() 反回的”msg” : “isdbgrid”表示连接的是mongos</li>
<li>sort：每个分片进行$orderby，primary shard最后进行merge sort</li>
<li>limits：每个分片limit，最后所有的结果再limit，之后返回结果</li>
<li>skips：不会将skips传递给单个分片，只是最后结果skip</li>
</ol>
<h3 id="shard-key"><a href="#shard-key" class="headerlink" title="shard key"></a>shard key</h3><ol>
<li>经常用于查询的feild</li>
<li>高基数的字段</li>
<li>使用组合字段作为shardkey</li>
<li>递增字段（查询：分散IO到不同的分片上，写入：一直在最后一个分片上） ，BSON objectID递增，使用reverse_id,转化为随机的，或者hash</li>
<li>非空的集合做分片，必须有一个片键开始的索引</li>
<li>hash分片只能创建在单独的一个field上</li>
<li>You cannot select a different shard key for that collection.</li>
<li>You cannot update the values of the shard key fields.</li>
<li>hash分片只能用在单个field上，分片更均匀，但是牺牲了Query Isolation。</li>
</ol>
<blockquote>
<p>没有shard的database，一般默认放在primary shard，挑选一个数据量最小的分片做为primary shard，可以使用movePrimary移动数据库，但是会影响数据访问</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; db.adminCommand( &#123; listDatabases: 1 &#125; )</span><br><span class="line">&#123;</span><br><span class="line">    &quot;databases&quot; : [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;name&quot; : &quot;test&quot;,</span><br><span class="line">            &quot;sizeOnDisk&quot; : 65536,</span><br><span class="line">            &quot;empty&quot; : false,</span><br><span class="line">            &quot;shards&quot; : &#123;</span><br><span class="line">                &quot;shard01&quot; : 65536</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;name&quot; : &quot;admin&quot;,</span><br><span class="line">            &quot;sizeOnDisk&quot; : 114688,</span><br><span class="line">            &quot;empty&quot; : false</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;name&quot; : &quot;config&quot;,</span><br><span class="line">            &quot;sizeOnDisk&quot; : 503808,</span><br><span class="line">            &quot;empty&quot; : false</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;totalSize&quot; : 684032,</span><br><span class="line">    &quot;totalSizeMb&quot; : 0,</span><br><span class="line">    &quot;ok&quot; : 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="shard-key-index"><a href="#shard-key-index" class="headerlink" title="shard key index"></a>shard key index</h3><ol>
<li>分片的collection必须有一个shard key的索引（index、compound index with prefix）</li>
<li>分片的集合，只有_id和片键可以有唯一索引，其他字段不能有唯一索引（因为索引都是local创建的，没办法保证cluster范围内唯一）</li>
</ol>
<h3 id="shard限制"><a href="#shard限制" class="headerlink" title="shard限制"></a>shard限制</h3><ol>
<li>group | db.eval() | $where | $isolated | $snapshot | geoSearch</li>
<li>updateOne() removeOne() deleteOne()必须在查询条件中包含shard key或_id</li>
</ol>
<h3 id="config-server-HA"><a href="#config-server-HA" class="headerlink" title="config server HA"></a>config server HA</h3><ol>
<li>如果config server没能选出primary，任然可以对分片读写，但是chunk的migration和split无法进行</li>
<li>数据保存在config数据库内，要备份！！！！</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/03/MongoDB-3-4-replication/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Feng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Feng">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/03/MongoDB-3-4-replication/" itemprop="url">MongoDB 3.4 - replication</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-03T10:13:38+08:00">
                2018-01-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MongoDB/" itemprop="url" rel="index">
                    <span itemprop="name">MongoDB</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/01/03/MongoDB-3-4-replication/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/01/03/MongoDB-3-4-replication/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="replication"><a href="#replication" class="headerlink" title="replication"></a>replication</h1><ul>
<li>statement based replication set(非binary)，所以复制集内MongoDB的版本可以不同，用于做rolling upgrade</li>
<li>primary删除了100条: db.foo.remove({age:30})  -> secondary: 100条命令 db.foo.remove({_id: }) ……<br>* </li>
</ul>
<h2 id="replicat-sets"><a href="#replicat-sets" class="headerlink" title="replicat sets"></a>replicat sets</h2><ul>
<li>自动failover （大概10s，6个9），应用（客户端）会自动连接到新的primary</li>
<li>自动recover，如果P节点down掉，选举产生新的P节点；老的P节点up之后，会自动rollback（回滚在该节点commit但是还没来得及sync到其他节点的操作），然后加入新的集群</li>
<li>复制集最多可以有50个成员，7个投票节点（建议每个复制集的arbiter不要超过1个）</li>
<li>hidden：priority 0，不可能成为primary，可以vote，只有数据复制的流量（没有读流量），用于报表和备份，db.isMaster()看不到</li>
<li>delay节点最好是hidden，priority 0, vote 1,备份的时候使用db.fsynclock()</li>
<li>non-vote节点，保证投票节点不超过7个，同时能分担读压力；priority 0， vote 0</li>
</ul>
<h2 id="create-replicate-set"><a href="#create-replicate-set" class="headerlink" title="create replicate set"></a>create replicate set</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mongod --port 27001 -replSet cluster --dbpath /data/1 --logpath /data/1/1.log --logappend --oplogSize 50 --smallfiles --fork</span><br><span class="line">mongod --port 27002 -replSet cluster --dbpath /data/2 --logpath /data/2/2.log --logappend --oplogSize 50 --smallfiles --fork</span><br><span class="line">mongod --port 27003 -replSet cluster --dbpath /data/3 --logpath /data/3/3.log --logappend --oplogSize 50 --smallfiles --fork</span><br><span class="line"></span><br><span class="line">mongo --port 27001</span><br><span class="line">&gt;  cfg = &#123;</span><br><span class="line">... _id : &quot;cluster&quot;,</span><br><span class="line">... members : [</span><br><span class="line">...  &#123; _id:0, host:&quot;mongotest:27001&quot; &#125;,</span><br><span class="line">...  &#123; _id:1, host:&quot;mongotest:27002&quot; &#125;,</span><br><span class="line">...  &#123; _id:2, host:&quot;mongotest:27003&quot; &#125;</span><br><span class="line">... ]</span><br><span class="line">... &#125;</span><br><span class="line"></span><br><span class="line">&gt; rs.initiate(cfg)</span><br><span class="line"></span><br><span class="line">帮助命令 rs.help()</span><br></pre></td></tr></table></figure>
<h3 id="使从节点能读"><a href="#使从节点能读" class="headerlink" title="使从节点能读"></a>使从节点能读</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cluster:SECONDARY&gt; rs.slaveOk(）</span><br><span class="line"></span><br><span class="line">for ( var i =0 ; i &lt; 50000 ; i++) &#123;db.foo.insert(&#123;_id : i&#125;); sleep(1);&#125;</span><br></pre></td></tr></table></figure>
<h3 id="replication-options"><a href="#replication-options" class="headerlink" title="replication options"></a>replication options</h3><ul>
<li>arbiterOnly: true   投票节点，没有数据</li>
<li>priority: <n>  0永远不会成为primary，不能是负数，可以有小数点</n></li>
<li>hidden: <bool> 隐藏节点，client不会看到，不会成为primary</bool></li>
<li>salveDelay: <seconds> 延迟节点，对于误操作快速恢复数据，不能用于fullbackup，priority=0 hidden=true</seconds></li>
<li>votes: <n></n></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">&gt; var cfg =rs.conf()</span><br><span class="line">&gt; &gt; cfg</span><br><span class="line">&#123;</span><br><span class="line">        &quot;_id&quot; : &quot;cluster&quot;,</span><br><span class="line">        &quot;version&quot; : 1,</span><br><span class="line">        &quot;protocolVersion&quot; : NumberLong(1),</span><br><span class="line">        &quot;members&quot; : [</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;_id&quot; : 0,</span><br><span class="line">                        &quot;host&quot; : &quot;mongotest:27001&quot;,</span><br><span class="line">                        &quot;arbiterOnly&quot; : false,</span><br><span class="line">                        &quot;buildIndexes&quot; : true,</span><br><span class="line">                        &quot;hidden&quot; : false,</span><br><span class="line">                        &quot;priority&quot; : 1,</span><br><span class="line">                        &quot;tags&quot; : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        &quot;slaveDelay&quot; : NumberLong(0),</span><br><span class="line">                        &quot;votes&quot; : 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;_id&quot; : 1,</span><br><span class="line">                        &quot;host&quot; : &quot;mongotest:27002&quot;,</span><br><span class="line">                        &quot;arbiterOnly&quot; : false,</span><br><span class="line">                        &quot;buildIndexes&quot; : true,</span><br><span class="line">                        &quot;hidden&quot; : false,</span><br><span class="line">                        &quot;priority&quot; : 1,</span><br><span class="line">                        &quot;tags&quot; : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        &quot;slaveDelay&quot; : NumberLong(0),</span><br><span class="line">                        &quot;votes&quot; : 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;_id&quot; : 2,</span><br><span class="line">                        &quot;host&quot; : &quot;mongotest:27003&quot;,</span><br><span class="line">                        &quot;arbiterOnly&quot; : false,</span><br><span class="line">                        &quot;buildIndexes&quot; : true,</span><br><span class="line">                        &quot;hidden&quot; : false,</span><br><span class="line">                        &quot;priority&quot; : 1,</span><br><span class="line">                        &quot;tags&quot; : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        &quot;slaveDelay&quot; : NumberLong(0),</span><br><span class="line">                        &quot;votes&quot; : 1</span><br><span class="line">                &#125;</span><br><span class="line">        ],</span><br><span class="line">        &quot;settings&quot; : &#123;</span><br><span class="line">                &quot;chainingAllowed&quot; : true,</span><br><span class="line">                &quot;heartbeatIntervalMillis&quot; : 2000,</span><br><span class="line">                &quot;heartbeatTimeoutSecs&quot; : 10,</span><br><span class="line">                &quot;electionTimeoutMillis&quot; : 10000,</span><br><span class="line">                &quot;catchUpTimeoutMillis&quot; : 60000,</span><br><span class="line">                &quot;getLastErrorModes&quot; : &#123;</span><br><span class="line"></span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;getLastErrorDefaults&quot; : &#123;</span><br><span class="line">                        &quot;w&quot; : 1,</span><br><span class="line">                        &quot;wtimeout&quot; : 0</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;replicaSetId&quot; : ObjectId(&quot;59c1d4b929c0b87e17d81e45&quot;)</span><br><span class="line">        &#125;</span><br><span class="line">&gt; cfg.members[2].slaveDelay = 120</span><br><span class="line">&gt; rs.reconfig(cfg)</span><br></pre></td></tr></table></figure>
<ul>
<li>3members（2data+1arbiter）,可以failover，但是writeconcern=majority不重要</li>
<li>2members 手工failover</li>
</ul>
<h3 id="init-sync"><a href="#init-sync" class="headerlink" title="init sync"></a>init sync</h3><ol>
<li>克隆除了local以外的所有数据库</li>
<li>3.4在克隆的时候会创建索引，3.4之前只会创建_id索引</li>
<li>克隆期间的oplog会复制到从节点并应用</li>
<li>init sync期间rename collection会重传</li>
</ol>
<h3 id="选举election"><a href="#选举election" class="headerlink" title="选举election"></a>选举election</h3><ol>
<li>选举期间，没有primary可写，其余的节点为read-only</li>
<li>和选举有关的因素：protocol （verison 1）、heartbeat（2秒一次，10秒没有响应被标记为、inaccessible）、priority（高优先级的节点更早发起选举，更有可能会赢得选举，成为primary；低优先级的如果数据更新会赢得选举）、Loss of a Data Center、network partition</li>
</ol>
<h3 id="rollback"><a href="#rollback" class="headerlink" title="rollback"></a>rollback</h3><ol>
<li>rollback的数据在目录dbpath下，database.collection.timestamp.bson，使用bsondump查看</li>
<li>默认write concern{w ： 1}，设为{w : majority}可以防止回滚</li>
<li>超过300M的数据不会被回滚</li>
</ol>
<h3 id="rs-status"><a href="#rs-status" class="headerlink" title="rs.status()"></a>rs.status()</h3><ol>
<li>rs.status()和db.adminCommand( { replSetGetStatus : 1 } )一样</li>
</ol>
<h3 id="oplog"><a href="#oplog" class="headerlink" title="oplog"></a>oplog</h3><ol>
<li>在primary操作后再写入oplog</li>
<li>保存在集合local.oplog.rs</li>
<li>oplog中的操作为幂等性，执行多次和一次结果一样</li>
<li>oplog size，unix（5%的free disk space、最大50G），通过参数oplogSizeMB指定大小</li>
</ol>
<h3 id="read-preference"><a href="#read-preference" class="headerlink" title="read preference"></a>read preference</h3><ol>
<li>默认从priamry读，nearest 从网络延迟最小的节点读取</li>
</ol>
<h3 id="write-concern"><a href="#write-concern" class="headerlink" title="write concern"></a>write concern</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">w: &lt;value&gt;, j: &lt;boolean&gt;, wtimeout: &lt;number&gt; &#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>w:默认1</li>
<li>如果mongodb的journal是enable的，w : “majority”隐含j: true</li>
<li>wtimeout:如果不设置，w：无法完成的时候，会一直block下去</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/02/MongoDB-3-4-CRUD-and-Administrative-Commands/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Feng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Feng">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/02/MongoDB-3-4-CRUD-and-Administrative-Commands/" itemprop="url">MongoDB 3.4 - CRUD and Administrative Commands</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-02T16:22:05+08:00">
                2018-01-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MongoDB/" itemprop="url" rel="index">
                    <span itemprop="name">MongoDB</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/01/02/MongoDB-3-4-CRUD-and-Administrative-Commands/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/01/02/MongoDB-3-4-CRUD-and-Administrative-Commands/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="CRUD-amp-admin命令"><a href="#CRUD-amp-admin命令" class="headerlink" title="CRUD&amp;admin命令"></a>CRUD&amp;admin命令</h1><h2 id="Insertion"><a href="#Insertion" class="headerlink" title="Insertion"></a>Insertion</h2><ul>
<li>key双引号用不用都可以</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.sample.insert(&#123;a:1&#125;)</span><br><span class="line">&gt; db.sample.insert(&#123;&quot;a&quot;:2&#125;)</span><br><span class="line">&gt; db.sample.find()</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;59b9e8abed80cf77d5636ae3&quot;), &quot;a&quot; : 1 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;59b9e984ed80cf77d5636ae4&quot;), &quot;a&quot; : 2 &#125;</span><br><span class="line"></span><br><span class="line">&gt; var x = db.sample.find().toArray()</span><br><span class="line">&gt; x</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;_id&quot; : ObjectId(&quot;59b9e8abed80cf77d5636ae3&quot;),</span><br><span class="line">        &quot;a&quot; : 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;_id&quot; : ObjectId(&quot;59b9e984ed80cf77d5636ae4&quot;),</span><br><span class="line">        &quot;a&quot; : 2</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h2 id="Update"><a href="#Update" class="headerlink" title="Update"></a>Update</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.&lt;collection&gt;.update(&lt;where&gt; , &lt;doc_or_partial_update_expression&gt;,&lt;upsert&gt;,&lt;multi&gt;)</span><br></pre></td></tr></table></figure>
<ol>
<li>full update/replace</li>
<li>partial update</li>
<li><where>后面不使用任何operator，将会替换整个文档</where></li>
<li>$set 修改对应的field， $inc 增加对应列的计数，如果原本不存在，则从1开始递增</li>
<li>$unset 删掉一个field</li>
<li>$rename 修改field的名字，逻辑上是做了$unset在$set,因此field在文档内的顺序可能会发生改变</li>
<li>$setOneInsert 如果upsert插入了一条文档，则生效  { $setOnInsert: { <field1>: <value1>, … } }</value1></field1></li>
<li>$mul 乘法运算 对象的field必须是数字类型的</li>
<li>$min $max 对比field和特定的值，如果符合则修改</li>
<li>Array操作：$set $push 增加 $pop 删除 $pushAll $pull $pullAll $addToSet </li>
<li>$push $addToSet 还可以使用 $each $slice $sort $position</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.array.insert(&#123; _id : 0 , a : [1, 2, 3, 4]&#125;)</span><br><span class="line">WriteResult(&#123; &quot;nInserted&quot; : 1 &#125;)</span><br><span class="line">&gt; db.array.find()</span><br><span class="line">&#123; &quot;_id&quot; : 0, &quot;a&quot; : [ 1, 2, 3, 4 ] &#125;</span><br><span class="line">&gt; db.array.update(&#123;_id : 0&#125;, &#123;$set : &#123;&quot;a.2&quot; : 5&#125;&#125;)</span><br><span class="line">WriteResult(&#123; &quot;nMatched&quot; : 1, &quot;nUpserted&quot; : 0, &quot;nModified&quot; : 1 &#125;)</span><br><span class="line">&gt; db.array.find()</span><br><span class="line">&#123; &quot;_id&quot; : 0, &quot;a&quot; : [ 1, 2, 5, 4 ] &#125;</span><br><span class="line">&gt; db.array.update(&#123;_id : 0&#125; , &#123;$push : &#123;a : 6&#125;&#125;)</span><br><span class="line">WriteResult(&#123; &quot;nMatched&quot; : 1, &quot;nUpserted&quot; : 0, &quot;nModified&quot; : 1 &#125;)</span><br><span class="line">&gt; db.array.find()</span><br><span class="line">&#123; &quot;_id&quot; : 0, &quot;a&quot; : [ 1, 2, 5, 4, 6 ] &#125;</span><br><span class="line"></span><br><span class="line">&gt; db.array.update(&#123;_id : 0&#125;, &#123;$pop : &#123;a : 1&#125;&#125;)</span><br><span class="line">WriteResult(&#123; &quot;nMatched&quot; : 1, &quot;nUpserted&quot; : 0, &quot;nModified&quot; : 1 &#125;)</span><br><span class="line">&gt; db.array.find()</span><br><span class="line">&#123; &quot;_id&quot; : 0, &quot;a&quot; : [ 1, 2, 5, 4 ] &#125;</span><br><span class="line">&gt; db.array.update(&#123;_id : 0&#125;, &#123;$pop : &#123;a : -1&#125;&#125;)</span><br><span class="line">WriteResult(&#123; &quot;nMatched&quot; : 1, &quot;nUpserted&quot; : 0, &quot;nModified&quot; : 1 &#125;)</span><br><span class="line">&gt; db.array.find()</span><br><span class="line">&#123; &quot;_id&quot; : 0, &quot;a&quot; : [ 2, 5, 4 ] &#125;</span><br><span class="line"></span><br><span class="line">&gt; db.array.update(&#123;_id : 0&#125;, &#123;$pushAll : &#123;a : [7, 8, 9]&#125;&#125;)</span><br><span class="line">WriteResult(&#123; &quot;nMatched&quot; : 1, &quot;nUpserted&quot; : 0, &quot;nModified&quot; : 1 &#125;)</span><br><span class="line">&gt; db.array.find()</span><br><span class="line">&#123; &quot;_id&quot; : 0, &quot;a&quot; : [ 2, 5, 4, 7, 8, 9 ] &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; db.array.update(&#123;_id : 0&#125;, &#123;$pull : &#123;a : 7&#125;&#125;)</span><br><span class="line">WriteResult(&#123; &quot;nMatched&quot; : 1, &quot;nUpserted&quot; : 0, &quot;nModified&quot; : 1 &#125;)</span><br><span class="line">&gt; db.array.find()</span><br><span class="line">&#123; &quot;_id&quot; : 0, &quot;a&quot; : [ 2, 5, 4, 8, 9 ] &#125;</span><br><span class="line"></span><br><span class="line">&gt; db.array.update(&#123;_id : 0&#125;, &#123;$pullAll : &#123;a : [7, 8, 9]&#125;&#125;)</span><br><span class="line">WriteResult(&#123; &quot;nMatched&quot; : 1, &quot;nUpserted&quot; : 0, &quot;nModified&quot; : 1 &#125;)</span><br><span class="line">&gt; db.array.find()</span><br><span class="line">&#123; &quot;_id&quot; : 0, &quot;a&quot; : [ 2, 5, 4 ] &#125;</span><br><span class="line"></span><br><span class="line">&gt; db.array.update(&#123;_id : 0&#125;, &#123;$addToSet : &#123;a : 1&#125;&#125;)</span><br><span class="line">WriteResult(&#123; &quot;nMatched&quot; : 1, &quot;nUpserted&quot; : 0, &quot;nModified&quot; : 1 &#125;)</span><br><span class="line">&gt; db.array.find()</span><br><span class="line">&#123; &quot;_id&quot; : 0, &quot;a&quot; : [ 2, 5, 4, 1 ] &#125;</span><br><span class="line">&gt; db.array.update(&#123;_id : 0&#125;, &#123;$addToSet : &#123;a : 1&#125;&#125;)</span><br><span class="line">WriteResult(&#123; &quot;nMatched&quot; : 1, &quot;nUpserted&quot; : 0, &quot;nModified&quot; : 0 &#125;)</span><br><span class="line">&gt; db.array.find()</span><br><span class="line">&#123; &quot;_id&quot; : 0, &quot;a&quot; : [ 2, 5, 4, 1 ] &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>_id不能update，_id在document的生命周期内不能改变</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&gt; var t = db.sample</span><br><span class="line">&gt; t.find()</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;59b9e8abed80cf77d5636ae3&quot;), &quot;a&quot; : 1 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;59b9e984ed80cf77d5636ae4&quot;), &quot;a&quot; : 2 &#125;</span><br><span class="line"></span><br><span class="line">&gt; myobj = t.findOne()</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;59b9e8abed80cf77d5636ae3&quot;), &quot;a&quot; : 1 &#125;</span><br><span class="line">&gt; myobj.y = 123</span><br><span class="line">123</span><br><span class="line">&gt; myobj</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;59b9e8abed80cf77d5636ae3&quot;), &quot;a&quot; : 1, &quot;y&quot; : 123 &#125;</span><br><span class="line"></span><br><span class="line">&gt; t.update(&#123;_id:myobj._id&#125;,myobj)</span><br><span class="line">WriteResult(&#123; &quot;nMatched&quot; : 1, &quot;nUpserted&quot; : 0, &quot;nModified&quot; : 1 &#125;)</span><br><span class="line">&gt; t.find()</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;59b9e8abed80cf77d5636ae3&quot;), &quot;a&quot; : 1, &quot;y&quot; : 123 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;59b9e984ed80cf77d5636ae4&quot;), &quot;a&quot; : 2 &#125;</span><br></pre></td></tr></table></figure>
<h2 id="Save"><a href="#Save" class="headerlink" title="Save()"></a>Save()</h2><blockquote>
<p>若新增的数据中存在主键 ，insert() 会提示错误，而save() 则更改原来的内容为新内容。</p>
<p>如：<br>已存在数据：  {_id : 1, “ name “ : “ n1 “ }，再次进行插入操作时，<br>insert({_id : 1, “ name “ : “ n2 “ })    会报主键重复的错误提示<br>save({ _id : 1, “ name “ : “ n2 “ })     会把 n1 修改为  n2  。</p>
<p>相同点：<br>若新增的数据中没有主键时，会增加一条记录。</p>
<p>已存在数据：  { _id : 1, “ name “ : “ n1 “ }，再次进行插入操作时，<br>insert({ “ name “ : “ n2 “ })    插入的数据因为没有主键，所以会增加一条数据<br>save({  “ name “ : “ n2 “ })   增加一条数据。</p>
</blockquote>
<h2 id="partial-update-amp-document-limited"><a href="#partial-update-amp-document-limited" class="headerlink" title="partial update &amp; document limited"></a>partial update &amp; document limited</h2><ul>
<li>每个文档（bson）大小限制16M</li>
<li>$set $push $addToset $pop $unset</li>
<li>db.collection.update({where},{obj},{upsert},{multi})   multi默认是false，只修改第一条match的document</li>
<li>upsert  如果query没有符合的document则insert一条，并且会将query中的等于条件的field也一起插入</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.foo.find()</span><br><span class="line">&gt; db.foo.update(&#123;a : 5, b : 5&#125;, &#123; $set : &#123;c : 10&#125;&#125;, &#123;upsert : true&#125;)</span><br><span class="line">WriteResult(&#123;</span><br><span class="line">    &quot;nMatched&quot; : 0,</span><br><span class="line">    &quot;nUpserted&quot; : 1,</span><br><span class="line">    &quot;nModified&quot; : 0,</span><br><span class="line">    &quot;_id&quot; : ObjectId(&quot;5a014bab2e7289371f61d474&quot;)</span><br><span class="line">&#125;)</span><br><span class="line">&gt; db.foo.find()</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014bab2e7289371f61d474&quot;), &quot;a&quot; : 5, &quot;b&quot; : 5, &quot;c&quot; : 10 &#125;</span><br><span class="line"></span><br><span class="line">&gt; db.foo.update(&#123;a : 5, b : 6&#125;, &#123; $set : &#123;c : 8&#125;&#125;, &#123;upsert : true&#125;)</span><br><span class="line">WriteResult(&#123;</span><br><span class="line">    &quot;nMatched&quot; : 0,</span><br><span class="line">    &quot;nUpserted&quot; : 1,</span><br><span class="line">    &quot;nModified&quot; : 0,</span><br><span class="line">    &quot;_id&quot; : ObjectId(&quot;5a014bfb2e7289371f61d47a&quot;)</span><br><span class="line">&#125;)</span><br><span class="line">&gt; db.foo.find()</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014bab2e7289371f61d474&quot;), &quot;a&quot; : 5, &quot;b&quot; : 5, &quot;c&quot; : 10 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014bfb2e7289371f61d47a&quot;), &quot;a&quot; : 5, &quot;b&quot; : 6, &quot;c&quot; : 8 &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; db.foo.update(&#123;a : 5, b : &#123; $eq : 7&#125;&#125;, &#123; $set : &#123;c : 6&#125;&#125;, &#123;upsert : true&#125;)</span><br><span class="line">WriteResult(&#123;</span><br><span class="line">    &quot;nMatched&quot; : 0,</span><br><span class="line">    &quot;nUpserted&quot; : 1,</span><br><span class="line">    &quot;nModified&quot; : 0,</span><br><span class="line">    &quot;_id&quot; : ObjectId(&quot;5a014cc32e7289371f61d48b&quot;)</span><br><span class="line">&#125;)</span><br><span class="line">&gt; </span><br><span class="line">&gt; </span><br><span class="line">&gt; db.foo.find()</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014bab2e7289371f61d474&quot;), &quot;a&quot; : 5, &quot;b&quot; : 5, &quot;c&quot; : 10 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014bfb2e7289371f61d47a&quot;), &quot;a&quot; : 5, &quot;b&quot; : 6, &quot;c&quot; : 8 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014cc32e7289371f61d48b&quot;), &quot;a&quot; : 5, &quot;b&quot; : 7, &quot;c&quot; : 6 &#125;</span><br></pre></td></tr></table></figure>
<h2 id="remove-document"><a href="#remove-document" class="headerlink" title="remove document"></a>remove document</h2><ul>
<li>db.collection.remove(<where expr="">)</where></li>
</ul>
<p>支持正则：db.test.remove({ x : /ello/ })</p>
<h2 id="the-basic-building-blocks-of-the-wire-protocol"><a href="#the-basic-building-blocks-of-the-wire-protocol" class="headerlink" title="the basic building blocks of the wire protocol"></a>the basic building blocks of the wire protocol</h2><ol>
<li>getmore</li>
<li>insert</li>
<li>query</li>
<li>remove</li>
</ol>
<h2 id="Bulk-write-operation"><a href="#Bulk-write-operation" class="headerlink" title="Bulk write operation"></a>Bulk write operation</h2><ul>
<li>db.collection.bulkWrite()</li>
<li>db.collection.insertMany()</li>
</ul>
<blockquote>
<p>bulkwrite支持order和unorder两种方式，order在一个失败操作后退出，unorder遇到失败后不会退出，直到全部执行完，性能上unorder要好，特别是在shared collection的环境内</p>
</blockquote>
<ul>
<li>initializeOrderedBulkOp()/initializeUnorderedBulkOp() version 3.2</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">var bulk = db.users.initializeOrderedBulkOp();</span><br><span class="line">bulk.insert( &#123; user: &quot;abc123&quot;, status: &quot;A&quot;, points: 0 &#125; );</span><br><span class="line">bulk.insert( &#123; user: &quot;ijk123&quot;, status: &quot;A&quot;, points: 0 &#125; );</span><br><span class="line">bulk.insert( &#123; user: &quot;mop123&quot;, status: &quot;P&quot;, points: 0 &#125; );</span><br><span class="line">bulk.find( &#123; status: &quot;D&quot; &#125; ).remove();</span><br><span class="line">bulk.find( &#123; status: &quot;P&quot; &#125; ).update( &#123; $set: &#123; comment: &quot;Pending&quot; &#125; &#125; );</span><br><span class="line">bulk.execute();</span><br></pre></td></tr></table></figure>
<h2 id="db-runCommand"><a href="#db-runCommand" class="headerlink" title="db.runCommand()"></a>db.runCommand()</h2><blockquote>
<p>db.runCommand(command)</p>
<p>This is the preferred method to issue database commands, as it provides a consistent interface between the shell and drivers.</p>
<p>[command][1]</p>
</blockquote>
<h2 id="help"><a href="#help" class="headerlink" title="help"></a>help</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&gt; help</span><br><span class="line">    db.help()                    help on db methods</span><br><span class="line">    db.mycoll.help()             help on collection methods</span><br><span class="line">    sh.help()                    sharding helpers</span><br><span class="line">    rs.help()                    replica set helpers</span><br><span class="line">    help admin                   administrative help</span><br><span class="line">    help connect                 connecting to a db help</span><br><span class="line">    help keys                    key shortcuts</span><br><span class="line">    help misc                    misc things to know</span><br><span class="line">    help mr                      mapreduce</span><br><span class="line"></span><br><span class="line">    show dbs                     show database names</span><br><span class="line">    show collections             show collections in current database</span><br><span class="line">    show users                   show users in current database</span><br><span class="line">    show profile                 show most recent system.profile entries with time &gt;= 1ms</span><br><span class="line">    show logs                    show the accessible logger names</span><br><span class="line">    show log [name]              prints out the last segment of log in memory, &apos;global&apos; is default</span><br><span class="line">    use &lt;db_name&gt;                set current database</span><br><span class="line">    db.foo.find()                list objects in collection foo</span><br><span class="line">    db.foo.find( &#123; a : 1 &#125; )     list objects in foo where a == 1</span><br><span class="line">    it                           result of the last line evaluated; use to further iterate</span><br><span class="line">    DBQuery.shellBatchSize = x   set default number of items to display on shell</span><br><span class="line">    exit                         quit the mongo shell</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">db.isMaster()</span><br><span class="line">&#123;</span><br><span class="line">    &quot;ismaster&quot; : true,</span><br><span class="line">    &quot;maxBsonObjectSize&quot; : 16777216,</span><br><span class="line">    &quot;maxMessageSizeBytes&quot; : 48000000,</span><br><span class="line">    &quot;maxWriteBatchSize&quot; : 1000,</span><br><span class="line">    &quot;localTime&quot; : ISODate(&quot;2017-09-19T01:11:48.180Z&quot;),</span><br><span class="line">    &quot;maxWireVersion&quot; : 5,</span><br><span class="line">    &quot;minWireVersion&quot; : 0,</span><br><span class="line">    &quot;readOnly&quot; : false,</span><br><span class="line">    &quot;ok&quot; : 1</span><br><span class="line">&#125;</span><br><span class="line">db.runCommand(&#123;isMaster:1&#125;)</span><br><span class="line">&#123;</span><br><span class="line">    &quot;ismaster&quot; : true,</span><br><span class="line">    &quot;maxBsonObjectSize&quot; : 16777216,</span><br><span class="line">    &quot;maxMessageSizeBytes&quot; : 48000000,</span><br><span class="line">    &quot;maxWriteBatchSize&quot; : 1000,</span><br><span class="line">    &quot;localTime&quot; : ISODate(&quot;2017-09-19T01:12:02.021Z&quot;),</span><br><span class="line">    &quot;maxWireVersion&quot; : 5,</span><br><span class="line">    &quot;minWireVersion&quot; : 0,</span><br><span class="line">    &quot;readOnly&quot; : false,</span><br><span class="line">    &quot;ok&quot; : 1</span><br><span class="line">&#125;</span><br><span class="line">db.runCommand(&quot;isMaster&quot;)</span><br><span class="line">&#123;</span><br><span class="line">    &quot;ismaster&quot; : true,</span><br><span class="line">    &quot;maxBsonObjectSize&quot; : 16777216,</span><br><span class="line">    &quot;maxMessageSizeBytes&quot; : 48000000,</span><br><span class="line">    &quot;maxWriteBatchSize&quot; : 1000,</span><br><span class="line">    &quot;localTime&quot; : ISODate(&quot;2017-09-19T01:12:33.016Z&quot;),</span><br><span class="line">    &quot;maxWireVersion&quot; : 5,</span><br><span class="line">    &quot;minWireVersion&quot; : 0,</span><br><span class="line">    &quot;readOnly&quot; : false,</span><br><span class="line">    &quot;ok&quot; : 1</span><br></pre></td></tr></table></figure>
<h2 id="demo-for-insert"><a href="#demo-for-insert" class="headerlink" title="demo for insert"></a>demo for insert</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">while(1) &#123;db.test3.insert(&#123;ts : new Date()&#125;)&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="find"><a href="#find" class="headerlink" title="find"></a>find</h2><p>find（）会返回游标cursor</p>
<p>db.collection.find(query, projection)</p>
<h4 id="对于字符类型，可以使用inequalities"><a href="#对于字符类型，可以使用inequalities" class="headerlink" title="对于字符类型，可以使用inequalities"></a>对于字符类型，可以使用inequalities</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.foo.find()</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014f4a5a0d4aef4446894e&quot;), &quot;name&quot; : &quot;Alex&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014f575a0d4aef4446894f&quot;), &quot;name&quot; : &quot;Bob&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014f5c5a0d4aef44468950&quot;), &quot;name&quot; : &quot;Clark&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014f625a0d4aef44468951&quot;), &quot;name&quot; : &quot;Dick&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014f6a5a0d4aef44468952&quot;), &quot;name&quot; : &quot;Eric&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014f6f5a0d4aef44468953&quot;), &quot;name&quot; : &quot;Frank&quot; &#125;</span><br><span class="line">&gt; db.foo.find(&#123;name : &#123;$lt : &apos;B&apos;&#125;&#125;)</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014f4a5a0d4aef4446894e&quot;), &quot;name&quot; : &quot;Alex&quot; &#125;</span><br><span class="line">&gt; db.foo.find(&#123;name : &#123;$lt : &apos;D&apos;, $gt : &apos;A&apos;&#125;&#125;)</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014f4a5a0d4aef4446894e&quot;), &quot;name&quot; : &quot;Alex&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014f575a0d4aef4446894f&quot;), &quot;name&quot; : &quot;Bob&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014f5c5a0d4aef44468950&quot;), &quot;name&quot; : &quot;Clark&quot; &#125;</span><br><span class="line">&gt; db.foo.find(&#123;name : &#123;$lt : &apos;b&apos;&#125;&#125;)</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014f4a5a0d4aef4446894e&quot;), &quot;name&quot; : &quot;Alex&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014f575a0d4aef4446894f&quot;), &quot;name&quot; : &quot;Bob&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014f5c5a0d4aef44468950&quot;), &quot;name&quot; : &quot;Clark&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014f625a0d4aef44468951&quot;), &quot;name&quot; : &quot;Dick&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014f6a5a0d4aef44468952&quot;), &quot;name&quot; : &quot;Eric&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014f6f5a0d4aef44468953&quot;), &quot;name&quot; : &quot;Frank&quot; &#125;</span><br></pre></td></tr></table></figure>
<h4 id="exists-type-regex"><a href="#exists-type-regex" class="headerlink" title="$exists $type $regex"></a>$exists $type $regex</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.foo.find()</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014f4a5a0d4aef4446894e&quot;), &quot;name&quot; : &quot;Alex&quot;, &quot;profession&quot; : &quot;Engineer&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014f575a0d4aef4446894f&quot;), &quot;name&quot; : &quot;Bob&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014f5c5a0d4aef44468950&quot;), &quot;name&quot; : &quot;Clark&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014f625a0d4aef44468951&quot;), &quot;name&quot; : &quot;Dick&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014f6a5a0d4aef44468952&quot;), &quot;name&quot; : &quot;Eric&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014f6f5a0d4aef44468953&quot;), &quot;name&quot; : &quot;Frank&quot; &#125;</span><br><span class="line">&gt; db.foo.find(&#123;profession : &#123; $exists : true&#125;&#125;)</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014f4a5a0d4aef4446894e&quot;), &quot;name&quot; : &quot;Alex&quot;, &quot;profession&quot; : &quot;Engineer&quot; &#125;</span><br><span class="line"></span><br><span class="line">&gt; db.foo.find(&#123;name : &#123; $type : 2&#125;&#125;)</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014f4a5a0d4aef4446894e&quot;), &quot;name&quot; : &quot;Alex&quot;, &quot;profession&quot; : &quot;Engineer&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014f575a0d4aef4446894f&quot;), &quot;name&quot; : &quot;Bob&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014f5c5a0d4aef44468950&quot;), &quot;name&quot; : &quot;Clark&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014f625a0d4aef44468951&quot;), &quot;name&quot; : &quot;Dick&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014f6a5a0d4aef44468952&quot;), &quot;name&quot; : &quot;Eric&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014f6f5a0d4aef44468953&quot;), &quot;name&quot; : &quot;Frank&quot; &#125;</span><br><span class="line">&gt; db.foo.find(&#123;name : &#123; $type : 1&#125;&#125;)</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a0152815a0d4aef44468954&quot;), &quot;name&quot; : 2 &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; db.foo.find(&#123;name : &#123; $regex : &apos;a&apos;&#125;&#125;)</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014f5c5a0d4aef44468950&quot;), &quot;name&quot; : &quot;Clark&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014f6f5a0d4aef44468953&quot;), &quot;name&quot; : &quot;Frank&quot; &#125;</span><br></pre></td></tr></table></figure>
<p>文档嵌套，查询的时候需要按照原来的顺序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.foo.find()</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014f4a5a0d4aef4446894e&quot;), &quot;name&quot; : &quot;Alex&quot;, &quot;profession&quot; : &quot;Engineer&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014f575a0d4aef4446894f&quot;), &quot;name&quot; : &quot;Bob&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014f5c5a0d4aef44468950&quot;), &quot;name&quot; : &quot;Clark&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014f625a0d4aef44468951&quot;), &quot;name&quot; : &quot;Dick&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014f6a5a0d4aef44468952&quot;), &quot;name&quot; : &quot;Eric&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a014f6f5a0d4aef44468953&quot;), &quot;name&quot; : &quot;Frank&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a0152815a0d4aef44468954&quot;), &quot;name&quot; : 2 &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a0157385a0d4aef44468955&quot;), &quot;name&quot; : &quot;richard&quot;, &quot;email&quot; : &#123; &quot;work&quot; : &quot;richard@work.com&quot;, &quot;personal&quot; : &quot;richard@person.com&quot; &#125; &#125;</span><br><span class="line">&gt; db.foo.find(&#123; &quot;email&quot; : &#123; &quot;work&quot; : &quot;richard@work.com&quot;, &quot;personal&quot; : &quot;richard@person.com&quot; &#125;&#125;)</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a0157385a0d4aef44468955&quot;), &quot;name&quot; : &quot;richard&quot;, &quot;email&quot; : &#123; &quot;work&quot; : &quot;richard@work.com&quot;, &quot;personal&quot; : &quot;richard@person.com&quot; &#125; &#125;</span><br><span class="line">&gt; db.foo.find(&#123; &quot;email&quot; : &#123; &quot;personal&quot; : &quot;richard@person.com&quot; , &quot;work&quot; : &quot;richard@work.com&quot; &#125;&#125;)</span><br><span class="line">&gt; </span><br><span class="line">&gt; db.foo.find(&#123; &quot;email.work&quot; : &quot;richard@work.com&quot;&#125; )</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5a0157385a0d4aef44468955&quot;), &quot;name&quot; : &quot;richard&quot;, &quot;email&quot; : &#123; &quot;work&quot; : &quot;richard@work.com&quot;, &quot;personal&quot; : &quot;richard@person.com&quot; &#125; &#125;</span><br></pre></td></tr></table></figure>
<h3 id="findAndModify"><a href="#findAndModify" class="headerlink" title="findAndModify"></a>findAndModify</h3><ol>
<li>修改并返回一条文档，可以使用sort等对符合条件的文档排序后再修改</li>
<li>默认返回的是修改前的文档，使用new： true返回修改后的文档</li>
<li>update（）可以修改多条（multi ： true），但是不能决定修改符合条件的多个文档中的哪一个文档</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">db.collection.findAndModify(&#123;</span><br><span class="line">    query: &lt;document&gt;,</span><br><span class="line">    sort: &lt;document&gt;,</span><br><span class="line">    remove: &lt;boolean&gt;,</span><br><span class="line">    update: &lt;document&gt;,</span><br><span class="line">    new: &lt;boolean&gt;,</span><br><span class="line">    fields: &lt;document&gt;,</span><br><span class="line">    upsert: &lt;boolean&gt;,</span><br><span class="line">    bypassDocumentValidation: &lt;boolean&gt;,</span><br><span class="line">    writeConcern: &lt;document&gt;,</span><br><span class="line">    collation: &lt;document&gt;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/02/MongoDB-3-4-Performance/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Feng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Feng">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/02/MongoDB-3-4-Performance/" itemprop="url">MongoDB 3.4 - Performance</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-02T16:16:17+08:00">
                2018-01-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MongoDB/" itemprop="url" rel="index">
                    <span itemprop="name">MongoDB</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/01/02/MongoDB-3-4-Performance/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/01/02/MongoDB-3-4-Performance/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="数据如何存储"><a href="#数据如何存储" class="headerlink" title="数据如何存储"></a>数据如何存储</h2><h3 id="默认参数启动"><a href="#默认参数启动" class="headerlink" title="默认参数启动"></a>默认参数启动</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mongod --dbpath /data/db --fork --logpath /data/db/mongodb.log</span><br><span class="line">mongo admin --eval &apos;db.shutdownServer()&apos;</span><br></pre></td></tr></table></figure>
<h4 id="按照不同的数据库存放文件"><a href="#按照不同的数据库存放文件" class="headerlink" title="按照不同的数据库存放文件"></a>按照不同的数据库存放文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mongod --dbpath /data/db --fork --logpath /data/db/mongodb.log  --directoryperdb</span><br><span class="line">mongo hello --eval &apos;db.a.insert(&#123;a:1&#125;,&#123;writeConcern: &#123;w:1, j:true&#125;&#125;)&apos;</span><br><span class="line">mongo admin --eval &apos;db.shutdownServer()&apos;</span><br></pre></td></tr></table></figure>
<h4 id="按照数据库将data和index分开在不同的目录"><a href="#按照数据库将data和index分开在不同的目录" class="headerlink" title="按照数据库将data和index分开在不同的目录"></a>按照数据库将data和index分开在不同的目录</h4> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mongod --dbpath /data/db --fork --logpath /data/db/mongodb.log  --directoryperdb --wiredTigerDirectoryForIndexes</span><br><span class="line">mongo hello --eval &apos;db.a.insert(&#123;a:1&#125;,&#123;writeConcern: &#123;w:1, j:true&#125;&#125;)&apos;</span><br><span class="line">mongo admin --eval &apos;db.shutdownServer()&apos;</span><br></pre></td></tr></table></figure>
<ol>
<li>在将数据写入disk支持压缩，小IO的性能更好</li>
<li>在将数据写入disk前，数据存在与内存中</li>
<li>两种方法触发数据从内存刷新到磁盘(a:&gt;db.collection.insert({…},{writeConcern: {w:3}})  b:checkpoint)</li>
<li>journal，防止不完全的数据写入``  </li>
</ol>
<h2 id="索引（single-key）"><a href="#索引（single-key）" class="headerlink" title="索引（single key）"></a>索引（single key）</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.&lt;collection&gt;.createIndex(&#123;&lt;field&gt;: &lt;direction&gt;&#125;)</span><br></pre></td></tr></table></figure>
<ol>
<li>key from on field</li>
<li>Can find single value for the indexed field</li>
<li>Can find a range of values</li>
<li>Can use dot natation to index fields in subdocuments</li>
<li>Can be used to find serveral distinct values in a single query</li>
<li>查询中包含排序，尽量使用到索引，如果没有索引该排序的feild，将会在内存中排序，代价高</li>
<li>索引列的查询排序，可以正向或者方向</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// explain a range query (using an index)</span><br><span class="line">exp.find( &#123; ssn : &#123; $gte : &quot;555-00-0000&quot;, $lt : &quot;556-00-0000&quot; &#125; &#125; )</span><br><span class="line"></span><br><span class="line">// explain a query on a set of values</span><br><span class="line">exp.find( &#123; &quot;ssn&quot; : &#123; $in : [ &quot;001-29-9184&quot;, &quot;177-45-0950&quot;, &quot;265-67-9973&quot; ] &#125; &#125; )</span><br><span class="line"></span><br><span class="line">// explain a query where only part of the predicates use a index</span><br><span class="line">exp.find( &#123; &quot;ssn&quot; : &#123; $in : [ &quot;001-29-9184&quot;, &quot;177-45-0950&quot;, &quot;265-67-9973&quot; ] &#125;, last_name : &#123; $gte : &quot;H&quot; &#125; &#125; )</span><br></pre></td></tr></table></figure>
<h2 id="Compound-Index"><a href="#Compound-Index" class="headerlink" title="Compound Index"></a>Compound Index</h2><blockquote>
<p>db.collection.createIndex( { <field1>: <type>, <field2>: <type2>, … } )</type2></field2></type></field1></p>
</blockquote>
<ol>
<li>多个fields的索引只有一个维度（One-dimensional）</li>
<li>引导字段会在查询中用到索引</li>
<li>index prefixes能被查询的过滤(filter)用到</li>
<li>index prefixes能被查询的排序(sort)用到</li>
<li>index prefixes可以按顺序查分开同时被filter和sort用到</li>
<li>compound索引的列不能为hash index type</li>
<li>MongoDB imposes a limit of 31 fields for any compound index.</li>
</ol>
<h2 id="Multikey-Index"><a href="#Multikey-Index" class="headerlink" title="Multikey Index"></a>Multikey Index</h2><ol>
<li>可以对array字段索引</li>
<li>不能创建基于多个array字段的compound索引，只能包含一个array字段</li>
</ol>
<h2 id="Partial-Index"><a href="#Partial-Index" class="headerlink" title="Partial Index"></a>Partial Index</h2><p>有时候为了降低存储空间，降低索引的维护管理成本，或者对一些字段特定的值比较关注，才会用到partial index</p>
<blockquote>
<p>db.restaurants.createIndex(<br>   { cuisine: 1, name: 1 },<br>   { partialFilterExpression: { rating: { $gt: 5 } } }<br>)</p>
</blockquote>
<ol>
<li>可以同时使用partialFilterExpression和sparse选项</li>
<li>_id不能创建partial index</li>
<li>shard key indexes不支持partial index</li>
</ol>
<h2 id="Building-index"><a href="#Building-index" class="headerlink" title="Building index"></a>Building index</h2><ol>
<li>foreground创建索引快，但会产生数据库锁？</li>
<li>background创建索引慢，但是不会阻塞操作，不会退出shell</li>
<li>background创建索引使用增量的方式，如果索引比可用内存大，会更慢</li>
<li>如果创建索引终止，mongod启动的时候可以指定参数storage.indexBuildRetry </li>
<li>secondary节点会在primary节点创建索引结束后开始创建</li>
<li>建议从节点启动到standalone模式，手工创建索引，再加入复制集</li>
</ol>
<h2 id="Query-plan"><a href="#Query-plan" class="headerlink" title="Query plan"></a>Query plan</h2><ol>
<li>查询优化器选择效率最高的基于可用索引的执行计划</li>
<li>查询优化器只缓存对于一个查询有多个可用执行计划的结果</li>
<li>mongod重启后plan cache丢失</li>
<li>如果index filter存在，则忽略hint（）</li>
</ol>
<h2 id="explain"><a href="#explain" class="headerlink" title="explain"></a>explain</h2><p>命令复杂，可以预先创建一个exp对象：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">exp = db.people.explain()</span><br><span class="line">exp.find(&#123;&quot;address.city&quot; : &quot;Lake Meaganton&quot;&#125;)</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>explain()并不会真的执行查询</p>
</blockquote>
<p>默认，不执行查询：<br>exp = db.people.explain(“queryPlanner”)</p>
<p>执行查询并返回统计结果<br>exp = db.people.explain(“executionStats”)</p>
<p>执行查询并返回详细结果<br>exp = db.people.explain(“allPlansExecution”)</p>
<h2 id="Resource-allocation-for-indexes"><a href="#Resource-allocation-for-indexes" class="headerlink" title="Resource allocation for indexes"></a>Resource allocation for indexes</h2><ol>
<li>可以使用compass查看每个database的索引大小</li>
<li>使用db.stats()查看所有索引的大小</li>
<li>尽量将索引cache到内存中，避免page in/out</li>
<li>并一一定要把全部索引cache到内存中，对于IOT或者类似自动增长的数据（时间等），可以只cache频繁被访问的数据的索引部分</li>
</ol>
<h2 id="索引与排序"><a href="#索引与排序" class="headerlink" title="索引与排序"></a>索引与排序</h2><ol>
<li>如果排序是在内存中进行的，执行计划里可以看到sort，如果是使用index排序，则explain()没有sort</li>
<li>compond index中{a:1, b:-1},下面两种情况都可以使用index sort：sort（{a:1,b:-1}）或者sort({a:-1, b:1})</li>
<li>compond index中{a:1, b:1, c:1}中，如果要使用c进行排序，则引导列的查询必须是等于=</li>
<li>正则匹配会被转化为范围查询，不是等值查询</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.data.find( &#123; a: 5 &#125; ).sort( &#123; b: 1, c: 1 &#125; )</span><br><span class="line">db.data.find( &#123; b: 3, a: 4 &#125; ).sort( &#123; c: 1 &#125; )</span><br><span class="line">db.data.find( &#123; a: 5, b: &#123; $lt: 3&#125; &#125; ).sort( &#123; b: 1 &#125; )</span><br></pre></td></tr></table></figure>
<h2 id="CRUD优化"><a href="#CRUD优化" class="headerlink" title="CRUD优化"></a>CRUD优化</h2><ol>
<li>index selectivity （索引创建在过滤条件好的feild上）</li>
<li>equality，sort，range（按照查询中=，排序，范围查询的优先级创建索引）</li>
<li>performance tradeoff（评估各种情况的优劣）</li>
<li>$and操作针对同一个field，否则会不走索引</li>
<li>field增加或减少的操作使用$inc，$inc会在server端完成，比update效率高，并且减少多进程修改同一个记录的争用</li>
</ol>
<h2 id="covered-query"><a href="#covered-query" class="headerlink" title="covered query"></a>covered query</h2><ol>
<li>explain()里面”totalDocsExamined” : 0, 所有需要返回的字段都包含在索引里</li>
<li>index feild是array或者embeded documents，或者查询不包含shard key，都不能使用coverd query</li>
<li>A geospatial indexes cannot cover a query.</li>
</ol>
<h2 id="insert-performance"><a href="#insert-performance" class="headerlink" title="insert performance"></a>insert performance</h2><ol>
<li>多一个索引（index overhead），写入性能可能比没有索引降低6.3%，5个索引降低34.4%</li>
<li>写关注（write concern），{w:1, j:false}为基线，{w:1, j:true}下降29.6%，{w:”majority”, j:false}下降40.7%，{w:”majority”, j:true}下降48.1%</li>
</ol>
<h2 id="storage-Engine-介绍"><a href="#storage-Engine-介绍" class="headerlink" title="storage Engine 介绍"></a>storage Engine 介绍</h2><h3 id="不会影响"><a href="#不会影响" class="headerlink" title="不会影响"></a>不会影响</h3><ul>
<li>mongodb的查询方式 （in shell/driver）</li>
<li>mongodb cluster的工作方式</li>
</ul>
<h3 id="会影响"><a href="#会影响" class="headerlink" title="会影响"></a>会影响</h3><ul>
<li>数据在磁盘上的 write/delete/remove/read</li>
<li>BSON存储数据的格式</li>
</ul>
<h3 id="可插拔"><a href="#可插拔" class="headerlink" title="可插拔"></a>可插拔</h3><ul>
<li>3.0开始支持</li>
<li>截至2015年3月，支持mmapV1和WireTiger</li>
</ul>
<h2 id="MMAPV1"><a href="#MMAPV1" class="headerlink" title="MMAPV1"></a>MMAPV1</h2><ul>
<li>是MongoDB原生的存储引擎</li>
<li>unix的mmap将磁盘文件隐射到虚拟内存空间</li>
<li>mongodb 3.0默认使用的是mmapV1</li>
</ul>
<h3 id="MMAPV1特点"><a href="#MMAPV1特点" class="headerlink" title="MMAPV1特点"></a>MMAPV1特点</h3><ul>
<li>2.2 - 2.6是databse锁</li>
<li>3.0 是collection锁</li>
</ul>
<blockquote>
<p>Lock–共享资源包括</p>
<ol>
<li>DATA</li>
<li>Metadata(Index/journal)</li>
</ol>
</blockquote>
<ul>
<li>Journal – write ahead log 保证磁盘数据一致性</li>
<li>空间分配方式：基于paddingFactor（填充因子）的自适应分配方式和基于usePowerOf2Sizes的预分配方式，默认使用usePowerOf2Sizes</li>
</ul>
<blockquote>
<p>案例1. data – journal（写入一半磁盘故障），磁盘恢复后：journal日志不全，忽略，磁盘上的数据是一致的</p>
<p>案例2. data – journal – disk(写入一般磁盘故障），磁盘恢复后,读取journal里的日志，sync到磁盘，磁盘上的数据是一致的</p>
</blockquote>
<h2 id="Wire-Tiger"><a href="#Wire-Tiger" class="headerlink" title="Wire Tiger"></a>Wire Tiger</h2><ul>
<li>document锁</li>
<li>支持压缩</li>
<li>性能提升</li>
<li>没有mmap那么多坑</li>
</ul>
<h3 id="查看启动信息"><a href="#查看启动信息" class="headerlink" title="查看启动信息"></a>查看启动信息</h3><p><code>&gt; db.startup_log.find().pretty()</code></p>
<h3 id="WT-internal"><a href="#WT-internal" class="headerlink" title="WT internal"></a>WT internal</h3><ul>
<li>以B-tree的形式存储数据</li>
<li>新数据直接写入未使用空间，之后在后台整理</li>
<li>update数据，直接写入new version的document（mmap是overwrite）</li>
<li>2中cache （WT: 默认大小为1/2的RAM ； FS）</li>
</ul>
<h3 id="checkpoint"><a href="#checkpoint" class="headerlink" title="checkpoint"></a>checkpoint</h3><ul>
<li>默认60s一次checkpoint,每个checkpoint数据都是一致性的snapshot</li>
<li>倒数第2个checkpoint一直到最后一个checkpoint数据全部写入磁盘才会删除</li>
<li>checkpoint触发数据从WT -&gt; FS -&gt; DISK 同时Truncate journal</li>
<li>document level lock</li>
<li>WT支持压缩（默认snappy zlib none）</li>
</ul>
<h3 id="索引操作"><a href="#索引操作" class="headerlink" title="索引操作"></a>索引操作</h3><ul>
<li>索引是经过排序的</li>
<li>sort查询，多个fields，只可以统一升序或降序</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.foo.createIndex(&#123;b:1&#125;)</span><br><span class="line">db.foo.getIndexes()</span><br><span class="line">db.foo.dropIndex(&#123;b:1&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><ul>
<li>索引的key可以是任意类型</li>
<li>_id自动创建索引（文档级别唯一，且生命周期内不可变)</li>
<li>可以对array索引(multikey index)</li>
<li>可以对子文档（subducoment）或者子域（subfield）索引</li>
<li>feildname不会保存在索引里</li>
</ul>
<h3 id="unique-Index"><a href="#unique-Index" class="headerlink" title="unique Index"></a>unique Index</h3><ul>
<li>unique索引的字段只能有一个document为空，其余的要保证唯一</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unique： true</span><br><span class="line">db.foo.createIndex(&#123;b:1&#125;,&#123;unique:true&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="sparse-Index"><a href="#sparse-Index" class="headerlink" title="sparse Index"></a>sparse Index</h3><ul>
<li>如果含有某个key的文档数量相比集合内的总文档数量少很多，可以用sparse index</li>
<li>创建了sparse和unique index的key，插入的文档可以不包含该key，如果包含了该key，则值要唯一</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sparse： true</span><br><span class="line">db.foo.createIndex(&#123;b:1&#125;,&#123;sparse:true&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="TTL-Index"><a href="#TTL-Index" class="headerlink" title="TTL Index"></a>TTL Index</h3><ul>
<li>使用TTL时是有限制的： </li>
<li>-如果要索引的字段已经在其他索引中使用，不能创建TTL索引</li>
<li>-索引不能包含多个字段</li>
<li>-如果定义的字段不存在，则永不过期</li>
<li>-不能对capped集合创建TTL索引</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;db.ttl.createIndex(&#123;&quot;expireAt&quot;: 1&#125;,&#123;expireAfterSeconds:0&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="Geospatial-Indexes"><a href="#Geospatial-Indexes" class="headerlink" title="Geospatial Indexes"></a>Geospatial Indexes</h3><h3 id="Text-Index"><a href="#Text-Index" class="headerlink" title="Text Index"></a>Text Index</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;db.foo.createIndex(&#123;a:&#125;)</span><br><span class="line">&gt;db.foo.find(&#123; $text : &#123; $search : &quot;Tree cat&quot;&#125;&#125;,&#123;score:&#123;$meta: &quot;textScore&quot;&#125;, _id:0 &#125;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>tree和cat不区分大小写，或的关系</p>
</blockquote>
<h3 id="background-Index-Creation"><a href="#background-Index-Creation" class="headerlink" title="background Index Creation"></a>background Index Creation</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">background:true</span><br></pre></td></tr></table></figure>
<ul>
<li>比foreground要慢，foreground会扫描集合中所有的key，排序，</li>
<li>随机IO</li>
<li>shell中会block直到结束</li>
<li>查询不会使用创建中的索引</li>
<li>2.6开始，secondary节点会和primary一样使用background模式，如果索引很大，性能考虑，将secondary重启到standalone模式创建索引，切换成primary，继续升级，但是创建索引的时间窗口必须在oplog内</li>
</ul>
<h2 id="Explain"><a href="#Explain" class="headerlink" title="Explain"></a>Explain</h2><ul>
<li>remove update的explain并不会改变数据</li>
<li>queryPlanner/executionStats/allPlansExecution三种模式</li>
</ul>
<h2 id="currentOP（）-amp-killOp（）"><a href="#currentOP（）-amp-killOp（）" class="headerlink" title="currentOP（）&amp;killOp（）"></a>currentOP（）&amp;killOp（）</h2><ul>
<li>查询</li>
<li>primary节点的findAndModify</li>
<li>primary节点的foreground创建索引</li>
</ul>
<h2 id="profiler"><a href="#profiler" class="headerlink" title="profiler"></a>profiler</h2><ul>
<li>针对数据库级别的，非整个mongod server</li>
<li>{0:off,1:slow,2:whole}</li>
<li>db.system.profile 是一个capped集合</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;db.setProfilingLevel(2)</span><br><span class="line">&gt;db.system.profile.find().pretty()</span><br><span class="line">&gt;db.system.profile.find().sort(&#123;$natural: -1&#125;).limit(1).pretty()</span><br><span class="line">&gt;db.getProfilingStatus()</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/28/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Feng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Feng">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/28/hello-world/" itemprop="url">Hello World</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-28T11:07:16+08:00">
                2017-12-28
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/12/28/hello-world/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/12/28/hello-world/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Feng</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Feng</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  

    
      <script id="dsq-count-scr" src="https://http-chnsin365-github-io.disqus.com/count.js" async></script>
    

    

  




	





  














  





  

  

  

  
  

  

  

  

</body>
</html>
